import{j as e}from"./query-vendor-BLxHmmGk.js";import{u as fe,r as m}from"./react-vendor-BeR0k5Z3.js";import{s as u,B as h,C as q,i as ve,k as je,g as $}from"./index-CX6yiz0b.js";import{I as _e}from"./input-CiHC6UAI.js";import{B as P}from"./badge-45Abp579.js";import{u as i,E as ye,l as z,K as Ne,O,ab as U,h as V,av as be,ar as we}from"./ui-vendor-DjQqXt9S.js";import{g as Ce}from"./invoiceGenerator-N-SvGSBq.js";import{C as R}from"./checkbox-BEepVNza.js";import{P as H,a as G,b as Q,C as W}from"./popover-BMhq8iVk.js";import{A as Se,a as De,b as ke,c as Ie,d as Ae,e as Fe,f as Pe,g as ze}from"./alert-dialog-Co4VP2kw.js";import{S as C,a as S,b as D,c as k,d as o}from"./select-CYWHo3cU.js";import{f as I}from"./format-sTPjOSS_.js";import"./supabase-vendor-VSDMYZ1k.js";import"./jspdf.plugin.autotable-41Os2KV8.js";import"./index-DjQc2W_p.js";import"./en-US-DWrl2lTx.js";import"./endOfMonth-DIWrT0r0.js";import"./subDays-ByyGNxrB.js";import"./index-D6fUEw85.js";import"./index-DhS5fNEb.js";import"./index-BdQq_4o_.js";import"./index-BC78nHQ6.js";const as=()=>{const A=fe(),[b,K]=m.useState([]),[x,Y]=m.useState([]),[g,Z]=m.useState(""),[j,J]=m.useState("all"),[w,X]=m.useState("all"),[ee,se]=m.useState(!0),[te,F]=m.useState(!1),[_,E]=m.useState(null),[l,y]=m.useState(new Set),[p,T]=m.useState(),[f,M]=m.useState(),[L,v]=m.useState(!1);m.useEffect(()=>{N()},[]),m.useEffect(()=>{ae()},[g,j,w,b,p,f]);const N=async()=>{try{const{data:{user:s}}=await u.auth.getUser();if(!s){i.error("Please sign in to view invoices"),A("/auth");return}const{data:t,error:n}=await u.from("manufacturing_cost_estimates").select("*").eq("user_id",s.id).eq("is_invoice_generated",!0).not("invoice_number","is",null).order("invoice_date",{ascending:!1});if(n)throw n;K(t||[])}catch(s){i.error("Failed to load invoices"),console.error("Error fetching invoices:",s)}finally{se(!1)}},ae=()=>{let s=b;g&&(s=s.filter(t=>{var n,c,a;return((n=t.invoice_number)==null?void 0:n.toLowerCase().includes(g.toLowerCase()))||((c=t.customer_name)==null?void 0:c.toLowerCase().includes(g.toLowerCase()))||((a=t.customer_email)==null?void 0:a.toLowerCase().includes(g.toLowerCase()))})),j!=="all"&&(s=s.filter(t=>t.status===j)),w!=="all"&&(s=s.filter(t=>t.invoice_status===w)),p&&(s=s.filter(t=>new Date(t.invoice_date)>=p)),f&&(s=s.filter(t=>new Date(t.invoice_date)<=f)),Y(s)},re=()=>{l.size===x.length?y(new Set):y(new Set(x.map(s=>s.id)))},ne=s=>{const t=new Set(l);t.has(s)?t.delete(s):t.add(s),y(t)},ie=async()=>{if(l.size===0){i.error("Please select invoices to export");return}v(!0);try{for(const s of l){const t=b.find(n=>n.id===s);t&&(await B(t),await new Promise(n=>setTimeout(n,500)))}i.success(`Exported ${l.size} invoices`)}catch{i.error("Failed to export some invoices")}finally{v(!1)}},oe=async()=>{if(l.size===0){i.error("Please select invoices to email");return}v(!0);try{const{data:{user:s}}=await u.auth.getUser();if(!s)return;const{data:t}=await u.from("vendor_profiles").select("business_name, email").eq("user_id",s.id).maybeSingle();let n=0;for(const c of l){const a=b.find(r=>r.id===c);if(a&&a.customer_email)try{const{error:r}=await u.functions.invoke("send-invoice-email",{body:{to:a.customer_email,customerName:a.customer_name,invoiceNumber:a.invoice_number,amount:a.final_selling_price,vendorName:(t==null?void 0:t.business_name)||"Your Vendor",vendorEmail:(t==null?void 0:t.email)||"vendor@example.com"}});r||n++}catch(r){console.error(`Failed to send email for ${a.invoice_number}:`,r)}}n>0?i.success(`Sent ${n} of ${l.size} emails`):i.error("Failed to send emails")}catch(s){i.error("Failed to send emails"),console.error(s)}finally{v(!1)}},le=async s=>{if(l.size===0){i.error("Please select invoices to update");return}v(!0);try{const{error:t}=await u.from("manufacturing_cost_estimates").update({status:s}).in("id",Array.from(l));if(t)throw t;i.success(`Updated ${l.size} invoices to ${s}`),y(new Set),N()}catch(t){i.error("Failed to update invoices"),console.error(t)}finally{v(!1)}},ce=async(s,t)=>{try{const n={invoice_status:t};t==="paid"?n.payment_date=new Date().toISOString():(t==="pending"||t==="cancelled")&&(n.payment_date=null);const{error:c}=await u.from("manufacturing_cost_estimates").update(n).eq("id",s);if(c)throw c;i.success(`Payment status updated to ${t}`),N()}catch(n){console.error("Error updating payment status:",n),i.error("Failed to update payment status")}},de=async s=>{if(!s.customer_email){i.error("No customer email available");return}try{const t=new Date(s.payment_due_date||s.created_at),n=new Date,c=s.invoice_status==="overdue"?Math.floor((n.getTime()-t.getTime())/(1e3*60*60*24)):0,{error:a}=await u.functions.invoke("send-payment-reminder",{body:{invoiceId:s.id,customerEmail:s.customer_email,customerName:s.customer_name,invoiceNumber:s.invoice_number,amount:s.final_selling_price||0,dueDate:s.payment_due_date,daysOverdue:c}});if(a)throw a;i.success("Payment reminder sent successfully"),N()}catch(t){console.error("Error sending payment reminder:",t),i.error("Failed to send payment reminder")}},B=async s=>{try{const{data:{user:t}}=await u.auth.getUser();if(!t)return;const{data:n,error:c}=await u.from("manufacturing_cost_estimates").select("*").eq("id",s.id).maybeSingle();if(c)throw c;if(!n){i.error("Invoice not found");return}const a=n,{data:r}=await u.from("vendor_profiles").select("*").eq("user_id",t.id).maybeSingle(),d=a.details||{},xe=a.line_items||[],ge=[r==null?void 0:r.address_line1,r==null?void 0:r.address_line2,r==null?void 0:r.city,r==null?void 0:r.state,r==null?void 0:r.pincode,r==null?void 0:r.country].filter(Boolean).join(", "),pe={invoiceNumber:a.invoice_number,invoiceDate:a.invoice_date,paymentDueDate:a.payment_due_date,paymentTerms:a.payment_terms,estimateName:a.estimate_name,status:a.status,customerName:a.customer_name,customerPhone:a.customer_phone,customerEmail:a.customer_email,customerAddress:a.customer_address,customerGSTIN:d.customer_gstin,vendorGSTIN:d.vendor_gstin,netWeight:a.net_weight,grossWeight:a.net_weight,purityFraction:a.purity_fraction,goldRate24k:a.gold_rate_24k,makingCharges:a.making_charges,cadDesignCharges:a.cad_design_charges,cammingCharges:a.camming_charges,certificationCost:a.certification_cost,diamondCost:a.diamond_cost,gemstoneCost:a.gemstone_cost,goldCost:a.gold_cost,totalCost:a.total_cost,profitMargin:a.profit_margin_percentage,finalSellingPrice:a.final_selling_price,gstMode:d.gst_mode,sgstPercentage:d.sgst_percentage,cgstPercentage:d.cgst_percentage,igstPercentage:d.igst_percentage,sgstAmount:d.sgst_amount,cgstAmount:d.cgst_amount,igstAmount:d.igst_amount,shippingCharges:d.shipping_charges,shippingZone:d.shipping_zone,exchangeRate:d.exchange_rate,grandTotal:d.grand_total,invoiceNotes:a.invoice_notes,lineItems:xe,details:d,vendorBranding:r?{name:r.business_name,logo:r.logo_url,primaryColor:r.primary_brand_color,secondaryColor:r.secondary_brand_color,tagline:r.brand_tagline,email:r.email,phone:r.phone,address:ge}:void 0};await Ce(pe),i.success("Invoice downloaded successfully")}catch(t){i.error("Failed to regenerate invoice"),console.error("Error regenerating invoice:",t)}},me=s=>{E(s),F(!0)},ue=async()=>{if(_)try{const{error:s}=await u.from("manufacturing_cost_estimates").delete().eq("id",_.id);if(s)throw s;i.success("Invoice deleted successfully"),F(!1),E(null),N()}catch(s){i.error("Failed to delete invoice"),console.error("Error deleting invoice:",s)}},he=s=>{A(`/manufacturing-cost?estimate=${s}`)};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-muted/20 p-4 md:p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs(h,{variant:"ghost",onClick:()=>A("/calculators"),className:"group",children:[e.jsx(ye,{className:"mr-2 h-4 w-4 transition-transform group-hover:-translate-x-1"}),"Back to Calculators"]}),e.jsxs(q,{className:"border-primary/10 shadow-2xl backdrop-blur-sm bg-card/95",children:[e.jsx(ve,{className:"bg-gradient-to-r from-primary/5 via-secondary/5 to-accent/5 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(je,{className:"text-3xl font-bold flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(z,{className:"h-7 w-7 text-primary"})}),"Invoice History"]}),e.jsxs(P,{variant:"secondary",className:"text-sm",children:[x.length," ",x.length===1?"Invoice":"Invoices"]})]})}),e.jsxs($,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Ne,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(_e,{placeholder:"Search by invoice number, customer name or email...",value:g,onChange:s=>Z(s.target.value),className:"pl-10"})]}),e.jsxs(C,{value:j,onValueChange:J,children:[e.jsx(S,{className:"w-full md:w-48",children:e.jsx(D,{placeholder:"Filter by status"})}),e.jsxs(k,{children:[e.jsx(o,{value:"all",children:"All Status"}),e.jsx(o,{value:"draft",children:"Draft"}),e.jsx(o,{value:"quoted",children:"Quoted"}),e.jsx(o,{value:"approved",children:"Approved"}),e.jsx(o,{value:"in_production",children:"In Production"}),e.jsx(o,{value:"completed",children:"Completed"})]})]}),e.jsxs(C,{value:w,onValueChange:X,children:[e.jsx(S,{className:"w-full md:w-48",children:e.jsx(D,{placeholder:"Payment status"})}),e.jsxs(k,{children:[e.jsx(o,{value:"all",children:"All Payments"}),e.jsx(o,{value:"pending",children:"Pending"}),e.jsx(o,{value:"paid",children:"Paid"}),e.jsx(o,{value:"overdue",children:"Overdue"}),e.jsx(o,{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsx("div",{className:"flex flex-col md:flex-row gap-4 items-start md:items-center",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs(H,{children:[e.jsx(G,{asChild:!0,children:e.jsxs(h,{variant:"outline",size:"sm",children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),p?I(p,"MMM dd, yyyy"):"From Date"]})}),e.jsx(Q,{className:"w-auto p-0",children:e.jsx(W,{mode:"single",selected:p,onSelect:T,initialFocus:!0})})]}),e.jsxs(H,{children:[e.jsx(G,{asChild:!0,children:e.jsxs(h,{variant:"outline",size:"sm",children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),f?I(f,"MMM dd, yyyy"):"To Date"]})}),e.jsx(Q,{className:"w-auto p-0",children:e.jsx(W,{mode:"single",selected:f,onSelect:M,initialFocus:!0})})]}),(p||f)&&e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{T(void 0),M(void 0)},children:"Clear Dates"})]})}),l.size>0&&e.jsxs("div",{className:"flex flex-wrap gap-2 items-center p-3 bg-primary/5 rounded-lg border border-primary/20",children:[e.jsxs("span",{className:"text-sm font-medium",children:[l.size," selected"]}),e.jsxs("div",{className:"flex gap-2 ml-auto flex-wrap",children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:ie,disabled:L,children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Export All"]}),e.jsxs(h,{size:"sm",variant:"outline",onClick:oe,disabled:L,children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Email All"]}),e.jsxs(C,{onValueChange:le,children:[e.jsx(S,{className:"w-[140px] h-9",children:e.jsx(D,{placeholder:"Update Status"})}),e.jsxs(k,{children:[e.jsx(o,{value:"draft",children:"Draft"}),e.jsx(o,{value:"quoted",children:"Quoted"}),e.jsx(o,{value:"approved",children:"Approved"}),e.jsx(o,{value:"in_production",children:"In Production"}),e.jsx(o,{value:"completed",children:"Completed"})]})]}),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>y(new Set),children:"Clear Selection"})]})]})]}),ee?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"}),e.jsx("p",{className:"text-muted-foreground text-lg",children:"Loading invoices..."})]}):x.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"p-4 rounded-full bg-muted/50 inline-block mb-4",children:e.jsx(z,{className:"h-16 w-16 text-muted-foreground"})}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"No invoices found"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:g||j!=="all"?"Try adjusting your filters":"Start creating invoices to see them here"})]}):e.jsxs("div",{className:"space-y-4",children:[x.length>0&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted/50 rounded-lg",children:[e.jsx(R,{checked:l.size===x.length,onCheckedChange:re}),e.jsxs("span",{className:"text-sm font-medium",children:["Select All (",x.length,")"]})]}),x.map(s=>{var t,n;return e.jsx(q,{className:"group hover:shadow-lg hover:border-primary/20 transition-all duration-200 bg-gradient-to-br from-card to-card/50",children:e.jsx($,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-6",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx(R,{checked:l.has(s.id),onCheckedChange:()=>ne(s.id),className:"mt-1"}),e.jsxs("div",{className:"space-y-3 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-primary/5 px-3 py-1.5 rounded-lg",children:[e.jsx(z,{className:"h-4 w-4 text-primary"}),e.jsx("h3",{className:"font-bold text-lg",children:s.invoice_number})]}),e.jsx(P,{variant:s.status==="completed"?"default":"secondary",className:"capitalize",children:(t=s.status)==null?void 0:t.replace("_"," ")}),e.jsx(P,{variant:s.invoice_status==="paid"?"default":s.invoice_status==="overdue"?"destructive":"outline",className:"text-xs capitalize",children:s.invoice_status||"pending"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Customer:"}),e.jsx("span",{className:"text-foreground",children:s.customer_name})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Date:"}),e.jsx("span",{className:"text-foreground",children:new Date(s.invoice_date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Due Date:"}),e.jsx("span",{className:"text-foreground",children:I(new Date(s.payment_due_date||s.created_at),"MMM dd, yyyy")})]}),s.payment_date&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Paid:"}),e.jsx("span",{className:"text-green-600 font-medium",children:I(new Date(s.payment_date),"MMM dd, yyyy")})]})]}),e.jsxs("div",{className:"flex items-baseline gap-2 pt-1",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Amount:"}),e.jsxs("span",{className:"text-2xl font-bold text-primary",children:["â‚¹",(n=s.final_selling_price)==null?void 0:n.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 pt-2",children:[e.jsxs(C,{value:s.invoice_status||"pending",onValueChange:c=>ce(s.id,c),children:[e.jsx(S,{className:"w-[150px] h-8 text-xs",children:e.jsx(D,{})}),e.jsxs(k,{children:[e.jsx(o,{value:"pending",children:"Pending"}),e.jsx(o,{value:"paid",children:"Paid"}),e.jsx(o,{value:"overdue",children:"Overdue"}),e.jsx(o,{value:"cancelled",children:"Cancelled"})]})]}),s.invoice_status!=="paid"&&s.customer_email&&e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>de(s),children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Send Reminder"]})]})]})]}),e.jsxs("div",{className:"flex gap-2 md:ml-3",children:[e.jsxs(h,{variant:"outline",size:"default",onClick:()=>he(s.id),className:"group/btn",children:[e.jsx(be,{className:"h-4 w-4 mr-2 transition-transform group-hover/btn:scale-110"}),"View Details"]}),e.jsxs(h,{size:"default",onClick:()=>B(s),className:"group/btn bg-primary hover:bg-primary/90",children:[e.jsx(U,{className:"h-4 w-4 mr-2 transition-transform group-hover/btn:translate-y-0.5"}),"Export PDF"]}),e.jsx(h,{variant:"outline",size:"icon",onClick:()=>me(s),className:"group/btn hover:bg-destructive hover:text-destructive-foreground hover:border-destructive",children:e.jsx(we,{className:"h-4 w-4 transition-transform group-hover/btn:scale-110"})})]})]})})},s.id)})]})]})]}),e.jsx(Se,{open:te,onOpenChange:F,children:e.jsxs(De,{children:[e.jsxs(ke,{children:[e.jsx(Ie,{children:"Delete Invoice"}),e.jsxs(Ae,{children:["Are you sure you want to delete invoice ",e.jsx("strong",{children:_==null?void 0:_.invoice_number}),"? This will permanently remove this invoice from your records. This action cannot be undone."]})]}),e.jsxs(Fe,{children:[e.jsx(Pe,{children:"Cancel"}),e.jsx(ze,{onClick:ue,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete Invoice"})]})]})})]})})};export{as as default};
//# sourceMappingURL=InvoiceHistory-DRu4jtaY.js.map
