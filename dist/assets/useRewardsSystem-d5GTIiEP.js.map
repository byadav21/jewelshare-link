{"version":3,"file":"useRewardsSystem-d5GTIiEP.js","sources":["../../src/hooks/useRewardsSystem.tsx"],"sourcesContent":["import { useState, useEffect } from \"react\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\n\r\ninterface VendorPoints {\r\n  total_points: number;\r\n  current_tier: string;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\ninterface PointsHistory {\r\n  id: string;\r\n  points: number;\r\n  action_type: string;\r\n  action_details: any;\r\n  created_at: string;\r\n}\r\n\r\nexport const useRewardsSystem = () => {\r\n  const [points, setPoints] = useState<VendorPoints | null>(null);\r\n  const [history, setHistory] = useState<PointsHistory[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    fetchPoints();\r\n    fetchHistory();\r\n    setupRealtimeListener();\r\n  }, []);\r\n\r\n  const fetchPoints = async () => {\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) return;\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"vendor_points\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", user.id)\r\n        .maybeSingle();\r\n\r\n      if (error && error.code !== 'PGRST116') throw error;\r\n      \r\n      if (!data) {\r\n        // Initialize points for new user\r\n        const { data: newPoints } = await supabase\r\n          .from(\"vendor_points\")\r\n          .insert({\r\n            user_id: user.id,\r\n            total_points: 0,\r\n            current_tier: 'bronze'\r\n          })\r\n          .select()\r\n          .single();\r\n        \r\n        setPoints(newPoints);\r\n      } else {\r\n        setPoints(data);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error fetching points:\", error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const fetchHistory = async () => {\r\n    try {\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n      if (!user) return;\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"points_history\")\r\n        .select(\"*\")\r\n        .eq(\"user_id\", user.id)\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(20);\r\n\r\n      if (error) throw error;\r\n      setHistory(data || []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching points history:\", error);\r\n    }\r\n  };\r\n\r\n  const setupRealtimeListener = async () => {\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    if (!user) return;\r\n    \r\n    const channel = supabase\r\n      .channel('points-updates')\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'UPDATE',\r\n          schema: 'public',\r\n          table: 'vendor_points',\r\n        },\r\n        (payload: any) => {\r\n          if (payload.new) {\r\n            setPoints(payload.new);\r\n          }\r\n        }\r\n      )\r\n      .on(\r\n        'postgres_changes',\r\n        {\r\n          event: 'INSERT',\r\n          schema: 'public',\r\n          table: 'points_history',\r\n        },\r\n        () => {\r\n          fetchHistory();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  };\r\n\r\n  const awardPoints = async (actionType: string, actionDetails?: any) => {\r\n    try {\r\n      const { data, error } = await supabase.functions.invoke('award-points', {\r\n        body: {\r\n          action_type: actionType,\r\n          action_details: actionDetails\r\n        }\r\n      });\r\n\r\n      if (error) throw error;\r\n      \r\n      // Refresh points after awarding\r\n      await fetchPoints();\r\n      \r\n      return data;\r\n    } catch (error) {\r\n      console.error(\"Error awarding points:\", error);\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  return {\r\n    points,\r\n    history,\r\n    loading,\r\n    awardPoints,\r\n    refetch: fetchPoints\r\n  };\r\n};\r\n"],"names":["useRewardsSystem","points","setPoints","useState","history","setHistory","loading","setLoading","useEffect","fetchPoints","fetchHistory","setupRealtimeListener","user","supabase","data","error","newPoints","channel","payload","actionType","actionDetails"],"mappings":"uFAkBO,MAAMA,EAAmB,IAAM,CACpC,KAAM,CAACC,EAAQC,CAAS,EAAIC,EAAAA,SAA8B,IAAI,EACxD,CAACC,EAASC,CAAU,EAAIF,EAAAA,SAA0B,CAAA,CAAE,EACpD,CAACG,EAASC,CAAU,EAAIJ,EAAAA,SAAS,EAAI,EAE3CK,EAAAA,UAAU,IAAM,CACdC,EAAA,EACAC,EAAA,EACAC,EAAA,CACF,EAAG,CAAA,CAAE,EAEL,MAAMF,EAAc,SAAY,CAC9B,GAAI,CACF,KAAM,CAAE,KAAM,CAAE,KAAAG,CAAA,GAAW,MAAMC,EAAS,KAAK,QAAA,EAC/C,GAAI,CAACD,EAAM,OAEX,KAAM,CAAE,KAAAE,EAAM,MAAAC,CAAA,EAAU,MAAMF,EAC3B,KAAK,eAAe,EACpB,OAAO,GAAG,EACV,GAAG,UAAWD,EAAK,EAAE,EACrB,YAAA,EAEH,GAAIG,GAASA,EAAM,OAAS,WAAY,MAAMA,EAE9C,GAAKD,EAcHZ,EAAUY,CAAI,MAdL,CAET,KAAM,CAAE,KAAME,GAAc,MAAMH,EAC/B,KAAK,eAAe,EACpB,OAAO,CACN,QAASD,EAAK,GACd,aAAc,EACd,aAAc,QAAA,CACf,EACA,OAAA,EACA,OAAA,EAEHV,EAAUc,CAAS,CACrB,CAGF,OAASD,EAAO,CACd,QAAQ,MAAM,yBAA0BA,CAAK,CAC/C,QAAA,CACER,EAAW,EAAK,CAClB,CACF,EAEMG,EAAe,SAAY,CAC/B,GAAI,CACF,KAAM,CAAE,KAAM,CAAE,KAAAE,CAAA,GAAW,MAAMC,EAAS,KAAK,QAAA,EAC/C,GAAI,CAACD,EAAM,OAEX,KAAM,CAAE,KAAAE,EAAM,MAAAC,CAAA,EAAU,MAAMF,EAC3B,KAAK,gBAAgB,EACrB,OAAO,GAAG,EACV,GAAG,UAAWD,EAAK,EAAE,EACrB,MAAM,aAAc,CAAE,UAAW,EAAA,CAAO,EACxC,MAAM,EAAE,EAEX,GAAIG,EAAO,MAAMA,EACjBV,EAAWS,GAAQ,EAAE,CACvB,OAASC,EAAO,CACd,QAAQ,MAAM,iCAAkCA,CAAK,CACvD,CACF,EAEMJ,EAAwB,SAAY,CACxC,KAAM,CAAE,KAAM,CAAE,KAAAC,CAAA,GAAW,MAAMC,EAAS,KAAK,QAAA,EAC/C,GAAI,CAACD,EAAM,OAEX,MAAMK,EAAUJ,EACb,QAAQ,gBAAgB,EACxB,GACC,mBACA,CACE,MAAO,SACP,OAAQ,SACR,MAAO,eAAA,EAERK,GAAiB,CACZA,EAAQ,KACVhB,EAAUgB,EAAQ,GAAG,CAEzB,CAAA,EAED,GACC,mBACA,CACE,MAAO,SACP,OAAQ,SACR,MAAO,gBAAA,EAET,IAAM,CACJR,EAAA,CACF,CAAA,EAED,UAAA,EAEH,MAAO,IAAM,CACXG,EAAS,cAAcI,CAAO,CAChC,CACF,EAuBA,MAAO,CACL,OAAAhB,EACA,QAAAG,EACA,QAAAE,EACA,YAzBkB,MAAOa,EAAoBC,IAAwB,CACrE,GAAI,CACF,KAAM,CAAE,KAAAN,EAAM,MAAAC,CAAA,EAAU,MAAMF,EAAS,UAAU,OAAO,eAAgB,CACtE,KAAM,CACJ,YAAaM,EACb,eAAgBC,CAAA,CAClB,CACD,EAED,GAAIL,EAAO,MAAMA,EAGjB,aAAMN,EAAA,EAECK,CACT,OAASC,EAAO,CACd,cAAQ,MAAM,yBAA0BA,CAAK,EACvCA,CACR,CACF,EAOE,QAASN,CAAA,CAEb"}