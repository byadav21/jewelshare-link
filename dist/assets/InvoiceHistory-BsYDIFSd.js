import{j as e}from"./query-vendor-BLxHmmGk.js";import{u as ze,r as c}from"./react-vendor-BeR0k5Z3.js";import{F as u,B as x,C as Q,G as Me,H as Te,D as W}from"./index-DGlTgSKx.js";import{I as Ee}from"./input-CEHl5GoJ.js";import{B as E}from"./badge-DknkzE8c.js";import{u as i,J as Le,l as L,z as Be,I as B,ae as J,h as Y,aH as Oe,ay as qe}from"./ui-vendor-CN4tOqpp.js";import{g as $e}from"./invoiceGenerator-BHCm5yW4.js";import{C as Z}from"./checkbox-Bj0qpZun.js";import{P as K,a as X,b as ee,C as O}from"./popover-NSDtVqGC.js";import{A as se,a as ae,b as te,c as re,d as ne,e as ie,f as le,g as oe}from"./alert-dialog-D1nisvxB.js";import{S,a as P,b as k,c as I,d as l}from"./select-CQfvDDtS.js";import{f as b}from"./format-CqKCEgBk.js";import"./supabase-vendor-VSDMYZ1k.js";import"./jspdf.plugin.autotable-DkGJWiqm.js";import"./index-DjQc2W_p.js";import"./endOfMonth-CPC63KWN.js";import"./subDays-BcNQht-D.js";import"./index-aqCwQlp3.js";import"./index-CVwUD2ep.js";import"./index-BdQq_4o_.js";import"./index-BC78nHQ6.js";const ds=()=>{const A=ze(),[C,ce]=c.useState([]),[h,de]=c.useState([]),[g,me]=c.useState(""),[j,ue]=c.useState("all"),[D,xe]=c.useState("all"),[he,ge]=c.useState(!0),[pe,F]=c.useState(!1),[_,q]=c.useState(null),[d,y]=c.useState(new Set),[p,$]=c.useState(),[f,U]=c.useState(),[V,v]=c.useState(!1),[fe,z]=c.useState(!1),[N,M]=c.useState(null),[T,R]=c.useState(new Date);c.useEffect(()=>{w()},[]),c.useEffect(()=>{ve()},[g,j,D,C,p,f]);const w=async()=>{try{const{data:{user:s}}=await u.auth.getUser();if(!s){i.error("Please sign in to view invoices"),A("/auth");return}const{data:a,error:n}=await u.from("manufacturing_cost_estimates").select("id, invoice_number, invoice_date, customer_name, customer_email, customer_phone, final_selling_price, status, invoice_status, payment_date, payment_due_date, estimate_name, created_at, last_reminder_sent_at").eq("user_id",s.id).eq("is_invoice_generated",!0).not("invoice_number","is",null).order("invoice_date",{ascending:!1});if(n)throw n;ce(a||[])}catch(s){i.error("Failed to load invoices"),console.error("Error fetching invoices:",s)}finally{ge(!1)}},ve=()=>{let s=C;g&&(s=s.filter(a=>{var n,o,t;return((n=a.invoice_number)==null?void 0:n.toLowerCase().includes(g.toLowerCase()))||((o=a.customer_name)==null?void 0:o.toLowerCase().includes(g.toLowerCase()))||((t=a.customer_email)==null?void 0:t.toLowerCase().includes(g.toLowerCase()))})),j!=="all"&&(s=s.filter(a=>a.status===j)),D!=="all"&&(s=s.filter(a=>a.invoice_status===D)),p&&(s=s.filter(a=>new Date(a.invoice_date)>=p)),f&&(s=s.filter(a=>new Date(a.invoice_date)<=f)),de(s)},je=()=>{d.size===h.length?y(new Set):y(new Set(h.map(s=>s.id)))},_e=s=>{const a=new Set(d);a.has(s)?a.delete(s):a.add(s),y(a)},ye=async()=>{if(d.size===0){i.error("Please select invoices to export");return}v(!0);try{for(const s of d){const a=C.find(n=>n.id===s);a&&(await G(a),await new Promise(n=>setTimeout(n,500)))}i.success(`Exported ${d.size} invoices`)}catch{i.error("Failed to export some invoices")}finally{v(!1)}},Ne=async()=>{if(d.size===0){i.error("Please select invoices to email");return}v(!0);try{const{data:{user:s}}=await u.auth.getUser();if(!s)return;const{data:a}=await u.from("vendor_profiles").select("business_name, email").eq("user_id",s.id).maybeSingle();let n=0;for(const o of d){const t=C.find(r=>r.id===o);if(t&&t.customer_email)try{const{error:r}=await u.functions.invoke("send-invoice-email",{body:{to:t.customer_email,customerName:t.customer_name,invoiceNumber:t.invoice_number,amount:t.final_selling_price,vendorName:(a==null?void 0:a.business_name)||"Your Vendor",vendorEmail:(a==null?void 0:a.email)||"vendor@example.com"}});r||n++}catch(r){console.error(`Failed to send email for ${t.invoice_number}:`,r)}}n>0?i.success(`Sent ${n} of ${d.size} emails`):i.error("Failed to send emails")}catch(s){i.error("Failed to send emails"),console.error(s)}finally{v(!1)}},we=async s=>{if(d.size===0){i.error("Please select invoices to update");return}v(!0);try{const{error:a}=await u.from("manufacturing_cost_estimates").update({status:s}).in("id",Array.from(d));if(a)throw a;i.success(`Updated ${d.size} invoices to ${s}`),y(new Set),w()}catch(a){i.error("Failed to update invoices"),console.error(a)}finally{v(!1)}},be=(s,a)=>{a==="paid"?(M(s),R(new Date),z(!0)):H(s.id,a,null)},H=async(s,a,n)=>{try{const o={invoice_status:a};a==="paid"&&n?o.payment_date=n.toISOString():(a==="pending"||a==="cancelled")&&(o.payment_date=null);const{error:t}=await u.from("manufacturing_cost_estimates").update(o).eq("id",s);if(t)throw t;i.success(`Payment status updated to ${a}`),w()}catch(o){console.error("Error updating payment status:",o),i.error("Failed to update payment status")}},Ce=async()=>{N&&(await H(N.id,"paid",T),z(!1),M(null))},De=async s=>{if(!s.customer_email){i.error("No customer email available");return}try{const a=new Date(s.payment_due_date||s.created_at),n=new Date,o=s.invoice_status==="overdue"?Math.floor((n.getTime()-a.getTime())/(1e3*60*60*24)):0,{error:t}=await u.functions.invoke("send-payment-reminder",{body:{invoiceId:s.id,customerEmail:s.customer_email,customerName:s.customer_name,invoiceNumber:s.invoice_number,amount:s.final_selling_price||0,dueDate:s.payment_due_date,daysOverdue:o}});if(t)throw t;i.success("Payment reminder sent successfully"),w()}catch(a){console.error("Error sending payment reminder:",a),i.error("Failed to send payment reminder")}},G=async s=>{try{const{data:{user:a}}=await u.auth.getUser();if(!a)return;const{data:n,error:o}=await u.from("manufacturing_cost_estimates").select("*").eq("id",s.id).maybeSingle();if(o)throw o;if(!n){i.error("Invoice not found");return}const t=n,{data:r}=await u.from("vendor_profiles").select("*").eq("user_id",a.id).maybeSingle(),m=t.details||{},Ie=t.line_items||[],Ae=[r==null?void 0:r.address_line1,r==null?void 0:r.address_line2,r==null?void 0:r.city,r==null?void 0:r.state,r==null?void 0:r.pincode,r==null?void 0:r.country].filter(Boolean).join(", "),Fe={invoiceNumber:t.invoice_number,invoiceDate:t.invoice_date,paymentDueDate:t.payment_due_date,paymentTerms:t.payment_terms,estimateName:t.estimate_name,status:t.status,customerName:t.customer_name,customerPhone:t.customer_phone,customerEmail:t.customer_email,customerAddress:t.customer_address,customerGSTIN:m.customer_gstin,vendorGSTIN:m.vendor_gstin,netWeight:t.net_weight,grossWeight:t.net_weight,purityFraction:t.purity_fraction,goldRate24k:t.gold_rate_24k,makingCharges:t.making_charges,cadDesignCharges:t.cad_design_charges,cammingCharges:t.camming_charges,certificationCost:t.certification_cost,diamondCost:t.diamond_cost,gemstoneCost:t.gemstone_cost,goldCost:t.gold_cost,totalCost:t.total_cost,profitMargin:t.profit_margin_percentage,finalSellingPrice:t.final_selling_price,gstMode:m.gst_mode,sgstPercentage:m.sgst_percentage,cgstPercentage:m.cgst_percentage,igstPercentage:m.igst_percentage,sgstAmount:m.sgst_amount,cgstAmount:m.cgst_amount,igstAmount:m.igst_amount,shippingCharges:m.shipping_charges,shippingZone:m.shipping_zone,exchangeRate:m.exchange_rate,grandTotal:m.grand_total,invoiceNotes:t.invoice_notes,lineItems:Ie,details:m,vendorBranding:r?{name:r.business_name,logo:r.logo_url,primaryColor:r.primary_brand_color,secondaryColor:r.secondary_brand_color,tagline:r.brand_tagline,email:r.email,phone:r.phone,address:Ae}:void 0};await $e(Fe),i.success("Invoice downloaded successfully")}catch(a){i.error("Failed to regenerate invoice"),console.error("Error regenerating invoice:",a)}},Se=s=>{q(s),F(!0)},Pe=async()=>{if(_)try{const{error:s}=await u.from("manufacturing_cost_estimates").delete().eq("id",_.id);if(s)throw s;i.success("Invoice deleted successfully"),F(!1),q(null),w()}catch(s){i.error("Failed to delete invoice"),console.error("Error deleting invoice:",s)}},ke=s=>{A(`/manufacturing-cost?estimate=${s}`)};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-muted/20 p-4 md:p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs(x,{variant:"ghost",onClick:()=>A("/calculators"),className:"group",children:[e.jsx(Le,{className:"mr-2 h-4 w-4 transition-transform group-hover:-translate-x-1"}),"Back to Calculators"]}),e.jsxs(Q,{className:"border-primary/10 shadow-2xl backdrop-blur-sm bg-card/95",children:[e.jsx(Me,{className:"bg-gradient-to-r from-primary/5 via-secondary/5 to-accent/5 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Te,{className:"text-3xl font-bold flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(L,{className:"h-7 w-7 text-primary"})}),"Invoice History"]}),e.jsxs(E,{variant:"secondary",className:"text-sm",children:[h.length," ",h.length===1?"Invoice":"Invoices"]})]})}),e.jsxs(W,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Be,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(Ee,{placeholder:"Search by invoice number, customer name or email...",value:g,onChange:s=>me(s.target.value),className:"pl-10"})]}),e.jsxs(S,{value:j,onValueChange:ue,children:[e.jsx(P,{className:"w-full md:w-48",children:e.jsx(k,{placeholder:"Filter by status"})}),e.jsxs(I,{children:[e.jsx(l,{value:"all",children:"All Status"}),e.jsx(l,{value:"draft",children:"Draft"}),e.jsx(l,{value:"quoted",children:"Quoted"}),e.jsx(l,{value:"approved",children:"Approved"}),e.jsx(l,{value:"in_production",children:"In Production"}),e.jsx(l,{value:"completed",children:"Completed"})]})]}),e.jsxs(S,{value:D,onValueChange:xe,children:[e.jsx(P,{className:"w-full md:w-48",children:e.jsx(k,{placeholder:"Payment status"})}),e.jsxs(I,{children:[e.jsx(l,{value:"all",children:"All Payments"}),e.jsx(l,{value:"pending",children:"Pending"}),e.jsx(l,{value:"paid",children:"Paid"}),e.jsx(l,{value:"overdue",children:"Overdue"}),e.jsx(l,{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsx("div",{className:"flex flex-col md:flex-row gap-4 items-start md:items-center",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs(K,{children:[e.jsx(X,{asChild:!0,children:e.jsxs(x,{variant:"outline",size:"sm",children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),p?b(p,"MMM dd, yyyy"):"From Date"]})}),e.jsx(ee,{className:"w-auto p-0",children:e.jsx(O,{mode:"single",selected:p,onSelect:$,initialFocus:!0})})]}),e.jsxs(K,{children:[e.jsx(X,{asChild:!0,children:e.jsxs(x,{variant:"outline",size:"sm",children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),f?b(f,"MMM dd, yyyy"):"To Date"]})}),e.jsx(ee,{className:"w-auto p-0",children:e.jsx(O,{mode:"single",selected:f,onSelect:U,initialFocus:!0})})]}),(p||f)&&e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>{$(void 0),U(void 0)},children:"Clear Dates"})]})}),d.size>0&&e.jsxs("div",{className:"flex flex-wrap gap-2 items-center p-3 bg-primary/5 rounded-lg border border-primary/20",children:[e.jsxs("span",{className:"text-sm font-medium",children:[d.size," selected"]}),e.jsxs("div",{className:"flex gap-2 ml-auto flex-wrap",children:[e.jsxs(x,{size:"sm",variant:"outline",onClick:ye,disabled:V,children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Export All"]}),e.jsxs(x,{size:"sm",variant:"outline",onClick:Ne,disabled:V,children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Email All"]}),e.jsxs(S,{onValueChange:we,children:[e.jsx(P,{className:"w-[140px] h-9",children:e.jsx(k,{placeholder:"Update Status"})}),e.jsxs(I,{children:[e.jsx(l,{value:"draft",children:"Draft"}),e.jsx(l,{value:"quoted",children:"Quoted"}),e.jsx(l,{value:"approved",children:"Approved"}),e.jsx(l,{value:"in_production",children:"In Production"}),e.jsx(l,{value:"completed",children:"Completed"})]})]}),e.jsx(x,{size:"sm",variant:"ghost",onClick:()=>y(new Set),children:"Clear Selection"})]})]})]}),he?e.jsx("div",{className:"space-y-4",children:[...Array(4)].map((s,a)=>e.jsx("div",{className:"rounded-lg border bg-card p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx("div",{className:"h-5 w-5 bg-muted animate-pulse rounded mt-1"}),e.jsxs("div",{className:"space-y-3 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-8 w-36 bg-muted animate-pulse rounded-lg"}),e.jsx("div",{className:"h-6 w-20 bg-muted animate-pulse rounded-full"}),e.jsx("div",{className:"h-6 w-20 bg-muted animate-pulse rounded-full"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("div",{className:"h-4 w-32 bg-muted animate-pulse rounded"}),e.jsx("div",{className:"h-4 w-40 bg-muted animate-pulse rounded"})]}),e.jsx("div",{className:"h-7 w-32 bg-muted animate-pulse rounded"})]})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx("div",{className:"h-9 w-24 bg-muted animate-pulse rounded"}),e.jsx("div",{className:"h-9 w-24 bg-muted animate-pulse rounded"}),e.jsx("div",{className:"h-9 w-20 bg-muted animate-pulse rounded"})]})]})},a))}):h.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"p-4 rounded-full bg-muted/50 inline-block mb-4",children:e.jsx(L,{className:"h-16 w-16 text-muted-foreground"})}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"No invoices found"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:g||j!=="all"?"Try adjusting your filters":"Start creating invoices to see them here"})]}):e.jsxs("div",{className:"space-y-4",children:[h.length>0&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted/50 rounded-lg",children:[e.jsx(Z,{checked:d.size===h.length,onCheckedChange:je}),e.jsxs("span",{className:"text-sm font-medium",children:["Select All (",h.length,")"]})]}),h.map(s=>{var a,n;return e.jsx(Q,{className:"group hover:shadow-lg hover:border-primary/20 transition-all duration-200 bg-gradient-to-br from-card to-card/50",children:e.jsx(W,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-6",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx(Z,{checked:d.has(s.id),onCheckedChange:()=>_e(s.id),className:"mt-1"}),e.jsxs("div",{className:"space-y-3 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-primary/5 px-3 py-1.5 rounded-lg",children:[e.jsx(L,{className:"h-4 w-4 text-primary"}),e.jsx("h3",{className:"font-bold text-lg",children:s.invoice_number})]}),e.jsx(E,{variant:s.status==="completed"?"default":"secondary",className:"capitalize",children:(a=s.status)==null?void 0:a.replace("_"," ")}),e.jsx(E,{variant:s.invoice_status==="paid"?"default":s.invoice_status==="overdue"?"destructive":"outline",className:"text-xs capitalize",children:s.invoice_status||"pending"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Customer:"}),e.jsx("span",{className:"text-foreground",children:s.customer_name})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Date:"}),e.jsx("span",{className:"text-foreground",children:new Date(s.invoice_date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Due Date:"}),e.jsx("span",{className:"text-foreground",children:b(new Date(s.payment_due_date||s.created_at),"MMM dd, yyyy")})]}),s.payment_date&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Paid:"}),e.jsx("span",{className:"text-green-600 font-medium",children:b(new Date(s.payment_date),"MMM dd, yyyy")})]})]}),e.jsxs("div",{className:"flex items-baseline gap-2 pt-1",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Amount:"}),e.jsxs("span",{className:"text-2xl font-bold text-primary",children:["â‚¹",(n=s.final_selling_price)==null?void 0:n.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 pt-2",children:[e.jsxs(S,{value:s.invoice_status||"pending",onValueChange:o=>be(s,o),children:[e.jsx(P,{className:"w-[150px] h-8 text-xs",children:e.jsx(k,{})}),e.jsxs(I,{children:[e.jsx(l,{value:"pending",children:"Pending"}),e.jsx(l,{value:"paid",children:"Mark as Paid"}),e.jsx(l,{value:"overdue",children:"Overdue"}),e.jsx(l,{value:"cancelled",children:"Cancelled"})]})]}),s.invoice_status!=="paid"&&s.customer_email&&e.jsxs(x,{size:"sm",variant:"outline",onClick:()=>De(s),children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Send Reminder"]})]})]})]}),e.jsxs("div",{className:"flex gap-2 md:ml-3",children:[e.jsxs(x,{variant:"outline",size:"default",onClick:()=>ke(s.id),className:"group/btn",children:[e.jsx(Oe,{className:"h-4 w-4 mr-2 transition-transform group-hover/btn:scale-110"}),"View Details"]}),e.jsxs(x,{size:"default",onClick:()=>G(s),className:"group/btn bg-primary hover:bg-primary/90",children:[e.jsx(J,{className:"h-4 w-4 mr-2 transition-transform group-hover/btn:translate-y-0.5"}),"Export PDF"]}),e.jsx(x,{variant:"outline",size:"icon",onClick:()=>Se(s),className:"group/btn hover:bg-destructive hover:text-destructive-foreground hover:border-destructive",children:e.jsx(qe,{className:"h-4 w-4 transition-transform group-hover/btn:scale-110"})})]})]})})},s.id)})]})]})]}),e.jsx(se,{open:pe,onOpenChange:F,children:e.jsxs(ae,{children:[e.jsxs(te,{children:[e.jsx(re,{children:"Delete Invoice"}),e.jsxs(ne,{children:["Are you sure you want to delete invoice ",e.jsx("strong",{children:_==null?void 0:_.invoice_number}),"? This will permanently remove this invoice from your records. This action cannot be undone."]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:"Cancel"}),e.jsx(oe,{onClick:Pe,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete Invoice"})]})]})}),e.jsx(se,{open:fe,onOpenChange:z,children:e.jsxs(ae,{className:"sm:max-w-md",children:[e.jsxs(te,{children:[e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5 text-primary"}),"Mark Invoice as Paid"]}),e.jsxs(ne,{children:["Select the payment date for invoice ",e.jsx("strong",{children:N==null?void 0:N.invoice_number})]})]}),e.jsx("div",{className:"py-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Payment Date"}),e.jsx(O,{mode:"single",selected:T,onSelect:s=>s&&R(s),className:"rounded-md border",initialFocus:!0}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Selected: ",e.jsx("span",{className:"font-medium text-foreground",children:b(T,"MMMM dd, yyyy")})]})]})}),e.jsxs(ie,{children:[e.jsx(le,{onClick:()=>M(null),children:"Cancel"}),e.jsx(oe,{onClick:Ce,className:"bg-green-600 text-white hover:bg-green-700",children:"Confirm Payment"})]})]})})]})})};export{ds as default};
//# sourceMappingURL=InvoiceHistory-BsYDIFSd.js.map
