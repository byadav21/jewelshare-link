import{j as e}from"./query-vendor-BLxHmmGk.js";import{u as Q,r as i}from"./react-vendor-BeR0k5Z3.js";import{F as g,B as h,C as T,G as W,H as Y,D as F}from"./index-DGlTgSKx.js";import{I as K}from"./input-CEHl5GoJ.js";import{B as D}from"./badge-DknkzE8c.js";import{u as d,J as X,l as N,s as L,z as Z,T as k,aH as ee,au as se,bm as ae,ay as te}from"./ui-vendor-CN4tOqpp.js";import{S as re,a as ie,b as le,c as ne,d as x}from"./select-CQfvDDtS.js";import{A as ce,a as de,b as oe,c as me,d as ue,e as he,f as xe,g as fe}from"./alert-dialog-D1nisvxB.js";import{T as ge,a as pe,b as I}from"./tabs-DfoelxW9.js";import"./supabase-vendor-VSDMYZ1k.js";import"./index-BdQq_4o_.js";import"./index-BC78nHQ6.js";import"./index-aqCwQlp3.js";import"./index-DjQc2W_p.js";import"./index-CVwUD2ep.js";import"./index-XJCymQHf.js";const q=o=>{if(!o)return null;const p=new Date(o),c=new Date(p);c.setDate(c.getDate()+30);const l=new Date,b=c.getTime()-l.getTime(),n=Math.ceil(b/(1e3*60*60*24));return Math.max(0,n)},Ie=()=>{const o=Q(),[p,c]=i.useState([]),[l,b]=i.useState([]),[n,z]=i.useState(""),[f,H]=i.useState("all"),[m,V]=i.useState("active"),[C,_]=i.useState(!0),[B,y]=i.useState(!1),[u,A]=i.useState(null),[w,S]=i.useState(!1),[E,v]=i.useState(!1);i.useEffect(()=>{R()},[m]),i.useEffect(()=>{M()},[n,f,p]);const R=async()=>{_(!0);try{const{data:{user:s}}=await g.auth.getUser();if(!s){d.error("Please sign in to view estimates"),o("/auth");return}let a=g.from("manufacturing_cost_estimates").select("*").eq("user_id",s.id).or("is_invoice_generated.is.null,is_invoice_generated.eq.false").order("created_at",{ascending:!1});m==="archived"?a=a.eq("is_archived",!0):a=a.or("is_archived.is.null,is_archived.eq.false");const{data:r,error:t}=await a;if(t)throw t;c(r||[])}catch(s){d.error("Failed to load estimates"),console.error("Error fetching estimates:",s)}finally{_(!1)}},M=()=>{let s=p;n&&(s=s.filter(a=>{var r,t,j;return((r=a.estimate_name)==null?void 0:r.toLowerCase().includes(n.toLowerCase()))||((t=a.customer_name)==null?void 0:t.toLowerCase().includes(n.toLowerCase()))||((j=a.customer_email)==null?void 0:j.toLowerCase().includes(n.toLowerCase()))})),f!=="all"&&(s=s.filter(a=>a.status===f)),b(s)},O=s=>{o(`/manufacturing-cost?estimate=${s}`)},P=s=>{o(`/invoice-generator?estimate=${s}`)},U=s=>{A(s),y(!0)},$=async()=>{if(u){S(!0);try{const{error:s}=await g.from("manufacturing_cost_estimates").delete().eq("id",u.id);if(s)throw s;c(a=>a.filter(r=>r.id!==u.id)),d.success("Estimate deleted permanently")}catch(s){d.error("Failed to delete estimate"),console.error("Error deleting estimate:",s)}finally{S(!1),y(!1),A(null)}}},G=async s=>{v(!0);try{const{error:a}=await g.from("manufacturing_cost_estimates").update({is_archived:!0,archived_at:new Date().toISOString()}).eq("id",s.id);if(a)throw a;c(r=>r.filter(t=>t.id!==s.id)),d.success("Estimate archived (auto-deletes after 30 days)")}catch(a){d.error("Failed to archive estimate"),console.error("Error archiving estimate:",a)}finally{v(!1)}},J=async s=>{v(!0);try{const{error:a}=await g.from("manufacturing_cost_estimates").update({is_archived:!1}).eq("id",s.id);if(a)throw a;c(r=>r.filter(t=>t.id!==s.id)),d.success("Estimate restored successfully")}catch(a){d.error("Failed to restore estimate"),console.error("Error restoring estimate:",a)}finally{v(!1)}};return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-muted/20 p-4 md:p-8",children:[e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs(h,{variant:"ghost",onClick:()=>o("/calculators"),className:"group",children:[e.jsx(X,{className:"mr-2 h-4 w-4 transition-transform group-hover:-translate-x-1"}),"Back to Calculators"]}),e.jsxs(T,{className:"border-primary/10 shadow-2xl backdrop-blur-sm bg-card/95",children:[e.jsx(W,{className:"bg-gradient-to-r from-primary/5 via-secondary/5 to-accent/5 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Y,{className:"text-3xl font-bold flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(N,{className:"h-7 w-7 text-primary"})}),"Estimate History"]}),e.jsxs(D,{variant:"secondary",className:"text-sm",children:[l.length," ",l.length===1?"Estimate":"Estimates"]})]})}),e.jsxs(F,{className:"p-6 space-y-6",children:[e.jsx(ge,{value:m,onValueChange:s=>V(s),className:"w-full",children:e.jsxs(pe,{className:"grid w-full max-w-xs grid-cols-2",children:[e.jsxs(I,{value:"active",className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4"}),"Active"]}),e.jsxs(I,{value:"archived",className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),"Archived"]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Z,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(K,{placeholder:"Search by estimate name, customer name or email...",value:n,onChange:s=>z(s.target.value),className:"pl-10"})]}),e.jsxs(re,{value:f,onValueChange:H,children:[e.jsx(ie,{className:"w-full md:w-48",children:e.jsx(le,{placeholder:"Filter by status"})}),e.jsxs(ne,{children:[e.jsx(x,{value:"all",children:"All Status"}),e.jsx(x,{value:"draft",children:"Draft"}),e.jsx(x,{value:"quoted",children:"Quoted"}),e.jsx(x,{value:"approved",children:"Approved"}),e.jsx(x,{value:"in_production",children:"In Production"}),e.jsx(x,{value:"completed",children:"Completed"})]})]})]}),m==="archived"&&l.length>0&&!C&&e.jsx("div",{className:"rounded-lg border border-destructive/30 bg-destructive/5 p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-destructive/10",children:e.jsx(k,{className:"h-5 w-5 text-destructive"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-destructive",children:"Archived Estimates"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["You have ",e.jsx("span",{className:"font-medium text-foreground",children:l.length})," archived ",l.length===1?"estimate":"estimates",".",(()=>{const s=l.filter(t=>t.archived_at).map(t=>({...t,daysLeft:q(t.archived_at)})).filter(t=>t.daysLeft!==null).sort((t,j)=>(t.daysLeft||0)-(j.daysLeft||0));if(s.length===0)return null;const r=s[0].daysLeft;return r===0?e.jsxs(e.Fragment,{children:[" The next deletion is ",e.jsx("span",{className:"font-medium text-destructive",children:"today"}),"."]}):r===1?e.jsxs(e.Fragment,{children:[" The next deletion is in ",e.jsx("span",{className:"font-medium text-destructive",children:"1 day"}),"."]}):e.jsxs(e.Fragment,{children:[" The next deletion is in ",e.jsxs("span",{className:"font-medium text-destructive",children:[r," days"]}),"."]})})()]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Archived estimates are automatically deleted after 30 days. Restore them to keep them permanently."})]})]})}),C?e.jsx("div",{className:"space-y-4",children:[...Array(4)].map((s,a)=>e.jsx("div",{className:"rounded-lg border bg-card p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"space-y-3 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-8 w-48 bg-muted animate-pulse rounded-lg"}),e.jsx("div",{className:"h-6 w-20 bg-muted animate-pulse rounded-full"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("div",{className:"h-4 w-32 bg-muted animate-pulse rounded"}),e.jsx("div",{className:"h-4 w-40 bg-muted animate-pulse rounded"})]}),e.jsx("div",{className:"h-6 w-28 bg-muted animate-pulse rounded"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"h-10 w-20 bg-muted animate-pulse rounded"}),e.jsx("div",{className:"h-10 w-32 bg-muted animate-pulse rounded"})]})]})},a))}):l.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"p-4 rounded-full bg-muted/50 inline-block mb-4",children:e.jsx(N,{className:"h-16 w-16 text-muted-foreground"})}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"No estimates found"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:n||f!=="all"?"Try adjusting your filters":"Start creating estimates to see them here"})]}):e.jsx("div",{className:"space-y-4",children:l.map(s=>{var a,r;return e.jsx(T,{className:"group hover:shadow-lg hover:border-primary/20 transition-all duration-200 bg-gradient-to-br from-card to-card/50",children:e.jsx(F,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-6",children:[e.jsxs("div",{className:"space-y-3 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-2 bg-primary/5 px-3 py-1.5 rounded-lg",children:[e.jsx(N,{className:"h-4 w-4 text-primary"}),e.jsx("h3",{className:"font-bold text-lg",children:s.estimate_name})]}),e.jsx(D,{variant:s.status==="completed"?"default":"secondary",className:"capitalize",children:(a=s.status)==null?void 0:a.replace("_"," ")}),m==="archived"&&s.archived_at&&e.jsxs(D,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(k,{className:"h-3 w-3"}),(()=>{const t=q(s.archived_at);return t===null?"Pending deletion":t===0?"Deleting today":t===1?"1 day left":`${t} days left`})()]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Customer:"}),e.jsx("span",{className:"text-foreground",children:s.customer_name||"N/A"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx("span",{className:"font-medium text-muted-foreground",children:"Created:"}),e.jsx("span",{className:"text-foreground",children:new Date(s.created_at).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"flex items-baseline gap-2 pt-1",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Amount:"}),e.jsxs("span",{className:"text-2xl font-bold text-primary",children:["â‚¹",(r=s.final_selling_price)==null?void 0:r.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]}),e.jsxs("div",{className:"flex gap-2 md:gap-3 flex-wrap",children:[e.jsxs(h,{variant:"outline",size:"default",onClick:()=>O(s.id),className:"group/btn",children:[e.jsx(ee,{className:"h-4 w-4 mr-2 transition-transform group-hover/btn:scale-110"}),"View"]}),m==="active"?e.jsxs(e.Fragment,{children:[e.jsxs(h,{size:"default",onClick:()=>P(s.id),className:"group/btn bg-primary hover:bg-primary/90",children:[e.jsx(se,{className:"h-4 w-4 mr-2 transition-transform group-hover/btn:scale-110"}),"Create Invoice"]}),e.jsxs(h,{variant:"secondary",size:"default",onClick:()=>G(s),disabled:E,className:"group/btn",children:[e.jsx(L,{className:"h-4 w-4 md:mr-2 transition-transform group-hover/btn:scale-110"}),e.jsx("span",{className:"hidden md:inline",children:"Archive"})]})]}):e.jsxs(h,{variant:"secondary",size:"default",onClick:()=>J(s),disabled:E,className:"group/btn",children:[e.jsx(ae,{className:"h-4 w-4 md:mr-2 transition-transform group-hover/btn:scale-110"}),e.jsx("span",{className:"hidden md:inline",children:"Restore"})]}),e.jsxs(h,{variant:"destructive",size:"default",onClick:()=>U(s),className:"group/btn",children:[e.jsx(te,{className:"h-4 w-4 md:mr-2 transition-transform group-hover/btn:scale-110"}),e.jsx("span",{className:"hidden md:inline",children:"Delete"})]})]})]})})},s.id)})})]})]})]}),e.jsx(ce,{open:B,onOpenChange:y,children:e.jsxs(de,{children:[e.jsxs(oe,{children:[e.jsx(me,{children:"Delete Estimate"}),e.jsxs(ue,{children:['Are you sure you want to delete "',u==null?void 0:u.estimate_name,'"? This action cannot be undone.']})]}),e.jsxs(he,{children:[e.jsx(xe,{disabled:w,children:"Cancel"}),e.jsx(fe,{onClick:$,disabled:w,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:w?"Deleting...":"Delete"})]})]})})]})};export{Ie as default};
//# sourceMappingURL=EstimateHistory-3htutMM3.js.map
