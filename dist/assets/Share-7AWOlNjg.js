import{j as e}from"./query-vendor-CIvqgC9B.js";import{r as l,u as U}from"./react-vendor-BCzWReGx.js";import{B as v,l as f,C as _,t as b,x as C,o as y,Z as Q}from"./index-DBHw7ps1.js";import{I as T}from"./input-CpEp8mrX.js";import{L as E}from"./label-Di_dI0OZ.js";import{C as q}from"./checkbox-UeKqwDGT.js";import{B as I}from"./badge-HmGNQ04n.js";import{Q as B,S as O,a as H}from"./ShareStats-Bdz68xmz.js";import{D as G,a as J,b as V,c as W,d as K,e as Y}from"./dialog-acGhLkoK.js";import{o as X,D as Z,u as g,aJ as ee,n as se,e as ae,a3 as te,b4 as re,a5 as ne,q as ie,aH as oe}from"./ui-vendor-B3Ur81tx.js";import{R as ce,L as le,C as de,X as me,Y as he,T as xe,a as pe,b as ue}from"./LineChart-DFkLEwQk.js";import{s as z}from"./subDays-BcNQht-D.js";import{f as F}from"./format-CqKCEgBk.js";import{C as ge,a as je,b as we}from"./collapsible-DtMuaJFy.js";import{P as fe}from"./PlanLimitWarning-Dvbnb2vk.js";import"./supabase-vendor-DJknrin8.js";import"./index-D6hZrTqZ.js";import"./index-BswhvY0M.js";import"./index-vsC2Ycwh.js";import"./linear-xawkJ-gZ.js";import"./index-C1BembgR.js";import"./alert-D-6GOIHR.js";const ve=({shareToken:h,businessName:j})=>{const p=`${window.location.origin}/shared/${encodeURIComponent(h)}`,i=()=>{const d=document.getElementById(`qr-${h}`);if(!d)return;const x=new XMLSerializer().serializeToString(d),m=document.createElement("canvas"),o=m.getContext("2d"),w=new Image;w.onload=()=>{m.width=w.width,m.height=w.height,o==null||o.drawImage(w,0,0),m.toBlob(D=>{if(D){const n=URL.createObjectURL(D),a=document.createElement("a");a.href=n,a.download=`catalog-qr-${h.substring(0,8)}.png`,a.click(),URL.revokeObjectURL(n),g.success("QR code downloaded!")}})},w.src="data:image/svg+xml;base64,"+btoa(x)},N=()=>{var m;const d=window.open("","_blank");if(!d)return;const x=j||"Jewelry Catalog";d.document.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>QR Code - ${x}</title>
          <style>
            body {
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              min-height: 100vh;
              margin: 0;
              font-family: Arial, sans-serif;
            }
            .container {
              text-align: center;
              padding: 40px;
            }
            h1 {
              margin-bottom: 20px;
              color: #333;
            }
            .qr-container {
              background: white;
              padding: 30px;
              border: 2px solid #333;
              border-radius: 10px;
              display: inline-block;
            }
            .instructions {
              margin-top: 30px;
              font-size: 14px;
              color: #666;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>${x}</h1>
            <div class="qr-container">
              ${((m=document.getElementById(`qr-${h}`))==null?void 0:m.outerHTML)||""}
            </div>
            <div class="instructions">
              <p>Scan this QR code to view our jewelry collection</p>
              <p style="font-size: 12px; margin-top: 10px;">${p}</p>
            </div>
          </div>
        </body>
      </html>
    `),d.document.close(),setTimeout(()=>{d.print()},250)};return e.jsxs(G,{children:[e.jsx(J,{asChild:!0,children:e.jsxs(v,{variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),"QR Code"]})}),e.jsxs(V,{className:"sm:max-w-md",children:[e.jsxs(W,{children:[e.jsx(K,{children:"Share Link QR Code"}),e.jsx(Y,{children:"Print or download this QR code to share your catalog offline"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-6 py-4",children:[e.jsx("div",{className:"bg-white p-6 rounded-xl border-2 border-primary/20 shadow-lg",children:e.jsx(B,{id:`qr-${h}`,value:p,size:256,level:"H",includeMargin:!0})}),e.jsxs("div",{className:"w-full",children:[e.jsx("p",{className:"text-xs text-muted-foreground text-center mb-2",children:"Catalog Link:"}),e.jsx("div",{className:"bg-muted rounded-lg px-3 py-2 text-xs text-center break-all",children:p})]}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs(v,{onClick:i,variant:"outline",className:"flex-1 gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),"Download"]}),e.jsxs(v,{onClick:N,className:"flex-1 gap-2",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})}),"Print"]})]})]})]})]})},_e=({shareLinkId:h,viewCount:j})=>{const[p,i]=l.useState(!0),[N,d]=l.useState([]),[x,m]=l.useState([]),[o,w]=l.useState(0);l.useEffect(()=>{D()},[h]);const D=async()=>{i(!0);try{const n=z(new Date,7),{data:a,error:u}=await f.from("share_link_product_views").select("viewed_at, product_id, products(name, image_url)").eq("share_link_id",h).gte("viewed_at",n.toISOString());if(u)throw u;const k={},R=Array.from({length:7},(t,r)=>{const c=z(new Date,6-r),L=F(c,"MMM dd");return k[L]=0,L});a==null||a.forEach(t=>{const r=F(new Date(t.viewed_at),"MMM dd");r in k&&k[r]++});const P=R.map(t=>({date:t,views:k[t]||0}));d(P);const S={};a==null||a.forEach(t=>{const r=t.products;r&&t.product_id&&(S[t.product_id]||(S[t.product_id]={count:0,name:r.name||"Unknown Product",image:r.image_url||null}),S[t.product_id].count++)});const s=Object.entries(S).map(([t,r])=>({id:t,name:r.name,image:r.image,views:r.count})).sort((t,r)=>r.views-t.views).slice(0,5);m(s),w((a==null?void 0:a.length)||0)}catch(n){console.error("Error fetching analytics:",n)}finally{i(!1)}};return p?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-32 bg-muted animate-pulse rounded-lg"}),e.jsx("div",{className:"h-64 bg-muted animate-pulse rounded-lg"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(_,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Catalog Views"}),e.jsx(ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(y,{children:[e.jsx("div",{className:"text-2xl font-bold",children:j}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total link opens"})]})]}),e.jsxs(_,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Product Views"}),e.jsx(se,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(y,{children:[e.jsx("div",{className:"text-2xl font-bold",children:o}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Individual product views"})]})]}),e.jsxs(_,{children:[e.jsxs(b,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"text-sm font-medium",children:"Engagement Rate"}),e.jsx(ae,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(y,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[j>0?(o/j*100).toFixed(1):"0","%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Products per visit"})]})]})]}),e.jsxs(_,{children:[e.jsx(b,{children:e.jsx(C,{className:"text-base",children:"Views Over Time (Last 7 Days)"})}),e.jsx(y,{children:e.jsx(ce,{width:"100%",height:250,children:e.jsxs(le,{data:N,children:[e.jsx(de,{strokeDasharray:"3 3"}),e.jsx(me,{dataKey:"date"}),e.jsx(he,{}),e.jsx(xe,{}),e.jsx(pe,{}),e.jsx(ue,{type:"monotone",dataKey:"views",stroke:"hsl(var(--primary))",strokeWidth:2,dot:{fill:"hsl(var(--primary))"}})]})})})]}),x.length>0&&e.jsxs(_,{children:[e.jsx(b,{children:e.jsx(C,{className:"text-base",children:"Most Viewed Products"})}),e.jsx(y,{children:e.jsx("div",{className:"space-y-4",children:x.map((n,a)=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(I,{variant:"secondary",className:"min-w-[2rem] justify-center",children:a+1}),n.image&&e.jsx("img",{src:n.image,alt:n.name,className:"h-12 w-12 object-cover rounded-md"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:n.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[n.views," views"]})]}),e.jsx("div",{className:"w-32 bg-muted rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full",style:{width:`${n.views/x[0].views*100}%`}})})]},n.id))})})]})]})},ye=()=>({awardPoints:async(j,p)=>{try{const{data:i,error:N}=await f.functions.invoke("award-points",{body:{action_type:j,action_details:p}});if(N)throw N;return i}catch(i){throw console.error("Error awarding points:",i),i}}}),Ge=()=>{const h=U(),{awardPoints:j}=ye(),[p,i]=l.useState(!1),[N,d]=l.useState(!0),[x,m]=l.useState([]),[o,w]=l.useState(null),[D,n]=l.useState(null),[a,u]=l.useState({markup_percentage:"",markdown_percentage:"",expires_at:"",show_vendor_details:!0,shared_categories:["Jewellery","Gemstones","Loose Diamonds"]});l.useEffect(()=>{(async()=>{try{const{data:{user:t}}=await f.auth.getUser();if(!t){d(!1);return}const[r,c]=await Promise.all([f.from("share_links").select("*").order("created_at",{ascending:!1}),f.from("vendor_profiles").select("business_name").eq("user_id",t.id).maybeSingle()]);r.error||m(r.data||[]),!c.error&&c.data&&w(c.data)}catch(t){console.error("Error fetching data:",t)}finally{d(!1)}})()},[]);const k=l.useCallback(async()=>{try{const{data:s,error:t}=await f.from("share_links").select("*").order("created_at",{ascending:!1});if(t)throw t;m(s||[])}catch{g.error("Failed to load share links")}},[]),R=async s=>{s.preventDefault(),i(!0);try{const{data:{user:t}}=await f.auth.getUser();if(!t)throw new Error("Not authenticated");const r=a.markup_percentage?parseFloat(a.markup_percentage):0,c=a.markdown_percentage?parseFloat(a.markdown_percentage):0;if(r>0&&c>0){g.error("Please use either markup or markdown, not both"),i(!1);return}if(a.shared_categories.length===0){g.error("Please select at least one product category to share"),i(!1);return}if(new Date(a.expires_at)<=new Date){g.error("Expiration date must be in the future"),i(!1);return}const{data:Ne,error:A}=await f.from("share_links").insert([{user_id:t.id,markup_percentage:r,markdown_percentage:c,expires_at:a.expires_at,show_vendor_details:a.show_vendor_details,shared_categories:a.shared_categories}]).select().single();if(A)throw A;try{await j("share_link_created")}catch(M){console.error("Failed to award points:",M)}g.success("Share link created successfully! ðŸŽ‰"),u({markup_percentage:"",markdown_percentage:"",expires_at:"",show_vendor_details:!0,shared_categories:["Jewellery","Gemstones","Loose Diamonds"]}),k()}catch(t){g.error(t.message||"Failed to create share link")}finally{i(!1)}},P=s=>{const t=`${window.location.origin}/shared/${encodeURIComponent(s)}`;navigator.clipboard.writeText(t),g.success("Link copied to clipboard!")},S=async(s,t)=>{try{const{error:r}=await f.from("share_links").update({is_active:!t}).eq("id",s);if(r)throw r;g.success(t?"Link deactivated":"Link activated"),k()}catch{g.error("Failed to update link status")}};return N?e.jsx("div",{className:"min-h-screen bg-background py-8",children:e.jsxs("div",{className:"container mx-auto px-4 max-w-4xl",children:[e.jsx("div",{className:"h-10 w-32 bg-muted animate-pulse rounded mb-6"}),e.jsxs(_,{className:"mb-8",children:[e.jsx(b,{children:e.jsx("div",{className:"h-8 w-48 bg-muted animate-pulse rounded"})}),e.jsxs(y,{className:"space-y-4",children:[e.jsx("div",{className:"h-24 bg-muted animate-pulse rounded"}),e.jsx("div",{className:"h-10 bg-muted animate-pulse rounded"})]})]})]})}):e.jsx(Q,{children:e.jsx("div",{className:"min-h-screen bg-background py-8",children:e.jsxs("div",{className:"container mx-auto px-4 max-w-4xl",children:[e.jsxs(v,{variant:"ghost",onClick:()=>h("/"),className:"mb-6",children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Back to Catalog"]}),e.jsxs(_,{className:"mb-8",children:[e.jsx(b,{children:e.jsx(C,{className:"text-3xl font-serif",children:"Create Share Link"})}),e.jsxs(y,{children:[e.jsx("div",{className:"mb-6",children:e.jsx(fe,{})}),e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"markup_percentage",children:"Markup % (optional)"}),e.jsx(T,{id:"markup_percentage",name:"markup_percentage",type:"number",step:"0.01",min:"0",max:"1000",value:a.markup_percentage,onChange:s=>u({...a,markup_percentage:s.target.value,markdown_percentage:""}),placeholder:"10"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"markdown_percentage",children:"Markdown % (optional)"}),e.jsx(T,{id:"markdown_percentage",name:"markdown_percentage",type:"number",step:"0.01",min:"0",max:"100",value:a.markdown_percentage,onChange:s=>u({...a,markdown_percentage:s.target.value,markup_percentage:""}),placeholder:"5"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"expires_at",children:"Expiration Date *"}),e.jsx(T,{id:"expires_at",name:"expires_at",type:"datetime-local",value:a.expires_at,onChange:s=>u({...a,expires_at:s.target.value}),min:new Date().toISOString().slice(0,16),required:!0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Set when this catalog link should stop working"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Product Categories to Share *"}),e.jsx("div",{className:"space-y-2",children:["Jewellery","Gemstones","Loose Diamonds"].map(s=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(q,{id:`category-${s}`,checked:a.shared_categories.includes(s),onCheckedChange:t=>{u(t?{...a,shared_categories:[...a.shared_categories,s]}:{...a,shared_categories:a.shared_categories.filter(r=>r!==s)})}}),e.jsx(E,{htmlFor:`category-${s}`,className:"cursor-pointer font-normal",children:s})]},s))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Select which product types to include in this share link"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"show_vendor_details",checked:a.show_vendor_details,onChange:s=>u({...a,show_vendor_details:s.target.checked}),className:"h-4 w-4 rounded border-input"}),e.jsx(E,{htmlFor:"show_vendor_details",className:"cursor-pointer",children:"Show vendor details in shared catalog header"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"When enabled, your business name, contact info, and QR codes will be visible in the shared catalog"})]}),e.jsx(v,{type:"submit",className:"w-full",disabled:p,children:p?"Creating Link...":"Create Share Link"})]})]})]}),e.jsxs(_,{children:[e.jsx(b,{children:e.jsx(C,{className:"text-2xl font-serif",children:"Your Share Links"})}),e.jsx(y,{children:x.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"No share links yet"}):e.jsx("div",{className:"space-y-4",children:x.map(s=>{var L;const t=`${window.location.origin}/shared/${encodeURIComponent(s.share_token)}`,r=new Date(s.expires_at).getTime()-new Date().getTime()<24*60*60*1e3,c=D===s.id;return e.jsx(_,{className:"border-border hover:border-primary/30 transition-colors",children:e.jsxs(y,{className:"p-4 space-y-3",children:[e.jsx(O,{viewCount:s.view_count,isExpiringSoon:r,showTrending:!0}),e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("code",{className:"text-sm bg-muted px-2 py-1 rounded truncate max-w-[200px]",children:[s.share_token.substring(0,20),"..."]}),e.jsx(v,{size:"sm",variant:"ghost",onClick:()=>P(s.share_token),children:e.jsx(re,{className:"h-4 w-4"})}),e.jsx(v,{size:"sm",variant:"ghost",onClick:()=>window.open(t,"_blank"),children:e.jsx(ne,{className:"h-4 w-4"})}),e.jsx(ve,{shareToken:s.share_token,businessName:o==null?void 0:o.business_name}),e.jsx(H,{url:t,title:(o==null?void 0:o.business_name)||"Exclusive Jewelry Collection",description:"Discover stunning jewelry pieces"})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-2",children:[s.markup_percentage>0&&`+${s.markup_percentage}% markup`,s.markdown_percentage>0&&`-${s.markdown_percentage}% markdown`,s.markup_percentage===0&&s.markdown_percentage===0&&"No price adjustment"," â€¢ ","Expires: ",new Date(s.expires_at).toLocaleString()]}),e.jsx("div",{className:"flex gap-1 mt-2 flex-wrap",children:(L=s.shared_categories)==null?void 0:L.map($=>e.jsx(I,{variant:"secondary",className:"text-xs",children:$},$))})]}),e.jsx(v,{size:"sm",variant:s.is_active?"destructive":"default",onClick:()=>S(s.id,s.is_active),children:s.is_active?"Deactivate":"Activate"})]}),e.jsxs(ge,{open:c,onOpenChange:()=>n(c?null:s.id),children:[e.jsx(je,{asChild:!0,children:e.jsxs(v,{variant:"outline",size:"sm",className:"w-full gap-2",children:[e.jsx(ie,{className:"h-4 w-4"}),c?"Hide Analytics":"View Analytics",e.jsx(oe,{className:`h-4 w-4 transition-transform ${c?"rotate-180":""}`})]})}),e.jsx(we,{className:"mt-4",children:e.jsx(_e,{shareLinkId:s.id,viewCount:s.view_count})})]})]})},s.id)})})})]})]})})})};export{Ge as default};
//# sourceMappingURL=Share-7AWOlNjg.js.map
