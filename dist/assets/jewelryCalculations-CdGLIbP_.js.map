{"version":3,"file":"jewelryCalculations-CdGLIbP_.js","sources":["../../src/utils/jewelryCalculations.ts"],"sourcesContent":["// ============================================\r\n// Jewelry Pricing Calculation Utilities\r\n// Shared between JewelleryForm and Import page\r\n// ============================================\r\n\r\n/**\r\n * Safely parse a number from various input types\r\n */\r\nexport const safeNumber = (val: any): number => {\r\n  if (typeof val === 'number' && !isNaN(val)) return val;\r\n  if (typeof val === 'string') {\r\n    const cleaned = val.replace(/[^0-9.-]/g, '');\r\n    const parsed = parseFloat(cleaned);\r\n    return isNaN(parsed) ? 0 : parsed;\r\n  }\r\n  return 0;\r\n};\r\n\r\n/**\r\n * Normalize purity value to decimal format (0-1)\r\n * Handles: decimal (0.76), karat (18 = 18K), percentage (76 or \"76%\")\r\n */\r\nexport const normalizePurity = (value: any): number => {\r\n  if (!value && value !== 0) return 18 / 24; // Default 18K = 0.75\r\n  \r\n  // Handle percentage string format\r\n  if (typeof value === 'string' && value.includes('%')) {\r\n    const numValue = parseFloat(value.replace(/[^0-9.-]/g, ''));\r\n    return numValue > 0 ? numValue / 100 : 18 / 24;\r\n  }\r\n  \r\n  const num = safeNumber(value);\r\n  if (num <= 0) return 18 / 24;\r\n  if (num <= 1) return num; // Already decimal (0.76)\r\n  if (num <= 24) return num / 24; // Karat value (18 = 18/24)\r\n  return num / 100; // Percentage (76 = 0.76)\r\n};\r\n\r\n/**\r\n * Get purity percentage for display\r\n */\r\nexport const getPurityPercentage = (purityValue: any): string => {\r\n  const normalized = normalizePurity(purityValue);\r\n  return (normalized * 100).toFixed(1);\r\n};\r\n\r\n/**\r\n * Standard karat options with decimal values\r\n */\r\nexport const KARAT_OPTIONS = [\r\n  { value: '14', label: '14K', decimal: 14 / 24, percentage: '58.3%' },\r\n  { value: '18', label: '18K', decimal: 18 / 24, percentage: '75%' },\r\n  { value: '22', label: '22K', decimal: 22 / 24, percentage: '91.7%' },\r\n  { value: '24', label: '24K', decimal: 24 / 24, percentage: '100%' },\r\n] as const;\r\n\r\n// ============================================\r\n// Jewelry Pricing Calculations\r\n// ============================================\r\n\r\nexport interface JewelryPriceInputs {\r\n  grossWeight: number;\r\n  gemstoneWeight: number;\r\n  dWt1: number;\r\n  dWt2: number;\r\n  dRate1: number;\r\n  pointerDiamond: number;\r\n  purityFraction: number;\r\n  goldRate: number;\r\n  makingChargesPerGram: number;\r\n  certificationCost: number;\r\n  gemstoneCost: number;\r\n}\r\n\r\nexport interface JewelryPriceOutputs {\r\n  totalDiamondWeight: number;\r\n  netWeight: number;\r\n  dValue: number;\r\n  makingCharges: number;\r\n  goldValue: number;\r\n  totalPrice: number;\r\n  costPrice: number;\r\n}\r\n\r\n/**\r\n * Calculate total diamond weight\r\n */\r\nexport const calculateDiamondWeight = (dWt1: number, dWt2: number): number => {\r\n  return safeNumber(dWt1) + safeNumber(dWt2);\r\n};\r\n\r\n/**\r\n * Calculate net weight: Gross Weight - (Total Diamond Weight + Gemstone Weight) / 5\r\n */\r\nexport const calculateNetWeight = (\r\n  grossWeight: number,\r\n  totalDiamondWeight: number,\r\n  gemstoneWeight: number\r\n): number => {\r\n  const gw = safeNumber(grossWeight);\r\n  const tdw = safeNumber(totalDiamondWeight);\r\n  const gsw = safeNumber(gemstoneWeight);\r\n  return Math.max(0, gw - (tdw + gsw) / 5);\r\n};\r\n\r\n/**\r\n * Calculate diamond value: (D.WT 1 × D RATE 1) + (D.WT 2 × Pointer diamond rate)\r\n */\r\nexport const calculateDValue = (\r\n  dWt1: number,\r\n  dRate1: number,\r\n  dWt2: number,\r\n  pointerDiamond: number\r\n): number => {\r\n  return safeNumber(dWt1) * safeNumber(dRate1) + safeNumber(dWt2) * safeNumber(pointerDiamond);\r\n};\r\n\r\n/**\r\n * Calculate making charges: Gross Weight × Making Charges Per Gram\r\n */\r\nexport const calculateMakingCharges = (\r\n  grossWeight: number,\r\n  makingChargesPerGram: number\r\n): number => {\r\n  return safeNumber(grossWeight) * safeNumber(makingChargesPerGram);\r\n};\r\n\r\n/**\r\n * Calculate gold value: Net Weight × Purity Fraction × Gold Rate\r\n */\r\nexport const calculateGoldValue = (\r\n  netWeight: number,\r\n  purityFraction: number,\r\n  goldRate: number\r\n): number => {\r\n  return safeNumber(netWeight) * safeNumber(purityFraction) * safeNumber(goldRate);\r\n};\r\n\r\n/**\r\n * Calculate total jewelry price\r\n * Formula: D VALUE + Making Charges + Gold Value + Certification Cost + Gemstone Cost\r\n */\r\nexport const calculateTotalPrice = (\r\n  dValue: number,\r\n  makingCharges: number,\r\n  goldValue: number,\r\n  certificationCost: number,\r\n  gemstoneCost: number\r\n): number => {\r\n  return (\r\n    safeNumber(dValue) +\r\n    safeNumber(makingCharges) +\r\n    safeNumber(goldValue) +\r\n    safeNumber(certificationCost) +\r\n    safeNumber(gemstoneCost)\r\n  );\r\n};\r\n\r\n/**\r\n * Calculate all jewelry pricing components at once\r\n */\r\nexport const calculateJewelryPricing = (inputs: JewelryPriceInputs): JewelryPriceOutputs => {\r\n  const {\r\n    grossWeight,\r\n    gemstoneWeight,\r\n    dWt1,\r\n    dWt2,\r\n    dRate1,\r\n    pointerDiamond,\r\n    purityFraction,\r\n    goldRate,\r\n    makingChargesPerGram,\r\n    certificationCost,\r\n    gemstoneCost,\r\n  } = inputs;\r\n\r\n  // Step 1: Calculate total diamond weight\r\n  const totalDiamondWeight = calculateDiamondWeight(dWt1, dWt2);\r\n\r\n  // Step 2: Calculate net weight\r\n  const netWeight = calculateNetWeight(grossWeight, totalDiamondWeight, gemstoneWeight);\r\n\r\n  // Step 3: Calculate diamond value\r\n  const dValue = calculateDValue(dWt1, dRate1, dWt2, pointerDiamond);\r\n\r\n  // Step 4: Calculate making charges\r\n  const makingCharges = calculateMakingCharges(grossWeight, makingChargesPerGram);\r\n\r\n  // Step 5: Calculate gold value\r\n  const goldValue = calculateGoldValue(netWeight, purityFraction, goldRate);\r\n\r\n  // Step 6: Calculate total price\r\n  const totalPrice = calculateTotalPrice(\r\n    dValue,\r\n    makingCharges,\r\n    goldValue,\r\n    certificationCost,\r\n    gemstoneCost\r\n  );\r\n\r\n  // Cost price equals total price (can be adjusted with margin later)\r\n  const costPrice = totalPrice > 0 ? totalPrice : 0.01;\r\n\r\n  return {\r\n    totalDiamondWeight,\r\n    netWeight,\r\n    dValue,\r\n    makingCharges,\r\n    goldValue,\r\n    totalPrice,\r\n    costPrice,\r\n  };\r\n};\r\n\r\n/**\r\n * Get value from row with multiple possible column names\r\n */\r\nconst getRowValue = (row: Record<string, any>, ...keys: string[]): any => {\r\n  for (const key of keys) {\r\n    if (row[key] !== undefined && row[key] !== null && row[key] !== '') {\r\n      return row[key];\r\n    }\r\n  }\r\n  return null;\r\n};\r\n\r\n/**\r\n * Process jewelry row data from Excel import\r\n * Supports multiple Excel column formats (GEMHUB format and standard format)\r\n */\r\nexport const processJewelryImportRow = (\r\n  row: Record<string, any>,\r\n  goldRate: number,\r\n  makingChargesPerGram: number\r\n): JewelryPriceOutputs & { purityFraction: number } => {\r\n  // Parse input values - support GEMHUB format and other column name formats\r\n  const grossWeight = safeNumber(\r\n    getRowValue(row, 'Gross Weight', 'G WT', 'GWT', 'GROSS_WEIGHT', 'Gross_Weight')\r\n  );\r\n  const gemstoneWeight = safeNumber(\r\n    getRowValue(row, 'GEMSTONE WT', 'Gemstone Weight', 'GS_WT', 'GEMSTONE_WEIGHT')\r\n  );\r\n  const dWt1 = safeNumber(\r\n    getRowValue(row, 'Diamond Weight 1', 'D.WT 1', 'D WT 1', 'DWT1', 'D_WT_1')\r\n  );\r\n  const dWt2 = safeNumber(\r\n    getRowValue(row, 'Diamond Weight 2', 'D.WT 2', 'D WT 2', 'DWT2', 'D_WT_2')\r\n  );\r\n  const dRate1 = safeNumber(\r\n    getRowValue(row, 'Diamond RATE 1', 'D RATE 1', 'D_RATE_1', 'DRATE1')\r\n  );\r\n  const pointerDiamond = safeNumber(\r\n    getRowValue(row, 'Diamond Rate 2', 'Pointer diamond', 'D RATE 2', 'D_RATE_2', 'POINTER_DIAMOND')\r\n  );\r\n  const certificationCost = safeNumber(\r\n    getRowValue(row, 'Certification cost', 'CERTIFICATION_COST', 'Cert Cost', 'CERT_COST')\r\n  );\r\n  const gemstoneCost = safeNumber(\r\n    getRowValue(row, 'Gemstone cost', 'GEMSTONE_COST', 'GS_COST')\r\n  );\r\n  \r\n  // Normalize purity - support multiple formats\r\n  const purityRaw = getRowValue(row, 'PURITY_FRACTION_USED', 'Purity', 'PURITY', 'Purity Fraction');\r\n  const purityFraction = normalizePurity(purityRaw);\r\n\r\n  // Check for pre-calculated values in Excel (GEMHUB format)\r\n  const netWeightFromExcel = safeNumber(\r\n    getRowValue(row, 'NET Weight', 'NET WT', 'Net Weight', 'NET_WEIGHT')\r\n  );\r\n  const dValueFromExcel = safeNumber(\r\n    getRowValue(row, 'D VALUE', 'DVALUE', 'Diamond Value')\r\n  );\r\n  const mkgFromExcel = safeNumber(\r\n    getRowValue(row, 'Making Charges', 'MKG', 'MAKING_CHARGES')\r\n  );\r\n  const goldFromExcel = safeNumber(\r\n    getRowValue(row, 'GOLD Cost', 'GOLD', 'Gold Value', 'GOLD_COST')\r\n  );\r\n  const totalFromExcel = safeNumber(\r\n    getRowValue(row, 'TOTAL', 'Total', 'TOTAL_PRICE', 'Total Price')\r\n  );\r\n\r\n  // Calculate values - ALWAYS recalculate using vendor profile values\r\n  // Only use Excel pre-calculated values for NET WT and D VALUE if provided\r\n  const totalDiamondWeight = calculateDiamondWeight(dWt1, dWt2);\r\n  const netWeight = netWeightFromExcel || calculateNetWeight(grossWeight, totalDiamondWeight, gemstoneWeight);\r\n  const dValue = dValueFromExcel || calculateDValue(dWt1, dRate1, dWt2, pointerDiamond);\r\n  \r\n  // ALWAYS calculate making charges and gold value from vendor profile\r\n  const makingCharges = calculateMakingCharges(grossWeight, makingChargesPerGram);\r\n  const goldValue = calculateGoldValue(netWeight, purityFraction, goldRate);\r\n  \r\n  // Calculate total price using calculated values\r\n  const totalPrice = calculateTotalPrice(dValue, makingCharges, goldValue, certificationCost, gemstoneCost);\r\n  const costPrice = totalPrice > 0 ? totalPrice : 0.01;\r\n\r\n  return {\r\n    totalDiamondWeight,\r\n    netWeight,\r\n    dValue,\r\n    makingCharges,\r\n    goldValue,\r\n    totalPrice,\r\n    costPrice,\r\n    purityFraction,\r\n  };\r\n};\r\n\r\n/**\r\n * Parse image URLs from Excel (supports pipe-separated URLs and escaped characters)\r\n */\r\nexport const parseImageUrls = (imageUrlValue: any): { url1: string | null; url2: string | null; url3: string | null } => {\r\n  if (!imageUrlValue) return { url1: null, url2: null, url3: null };\r\n  \r\n  // Clean up escaped characters from Excel (e.g., \"https\\://...\" or \"\\|\")\r\n  let urlString = String(imageUrlValue).trim()\r\n    .replace(/\\\\:/g, ':')  // Fix escaped colons\r\n    .replace(/\\\\\\|/g, '|') // Fix escaped pipes\r\n    .replace(/\\\\/g, '');   // Remove remaining backslashes\r\n  \r\n  // Handle pipe-separated URLs\r\n  if (urlString.includes('|')) {\r\n    const urls = urlString.split('|').map(u => u.trim()).filter(u => u);\r\n    return {\r\n      url1: urls[0] || null,\r\n      url2: urls[1] || null,\r\n      url3: urls[2] || null,\r\n    };\r\n  }\r\n  \r\n  return { url1: urlString || null, url2: null, url3: null };\r\n};"],"names":["safeNumber","val","cleaned","parsed","normalizePurity","value","numValue","num","getPurityPercentage","purityValue","KARAT_OPTIONS","calculateDiamondWeight","dWt1","dWt2","calculateNetWeight","grossWeight","totalDiamondWeight","gemstoneWeight","gw","tdw","gsw","calculateDValue","dRate1","pointerDiamond","calculateMakingCharges","makingChargesPerGram","calculateGoldValue","netWeight","purityFraction","goldRate","calculateTotalPrice","dValue","makingCharges","goldValue","certificationCost","gemstoneCost","getRowValue","row","keys","key","processJewelryImportRow","purityRaw","netWeightFromExcel","dValueFromExcel","totalPrice","costPrice"],"mappings":"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"}