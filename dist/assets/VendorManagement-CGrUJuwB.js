import{j as e}from"./query-vendor-BLxHmmGk.js";import{u as we,r as x}from"./react-vendor-BeR0k5Z3.js";import{Z as be,F as m,_ as ke,B as D,C as ae,G as re,H as ne,I as ie,D as te}from"./index-DGlTgSKx.js";import{B as ye}from"./badge-DknkzE8c.js";import{S as t}from"./switch-CO0K2nGH.js";import{u as h,J as Ce,p as Ne,ay as De}from"./ui-vendor-CN4tOqpp.js";import{T as ce,a as de,b as g,c as _,d as oe,e as d}from"./table-BDYxPG4d.js";import{A as Se,h as Pe,a as Fe,b as Ae,c as Te,d as Ve,e as Ee,f as Le,g as Me}from"./alert-dialog-D1nisvxB.js";import{D as He,b as Ie,c as Ue,d as Be,e as qe}from"./dialog-CRWggOUB.js";import{L as i}from"./label-ClRcubO_.js";import{I as ze}from"./input-CEHl5GoJ.js";import{S as Oe,a as $e,b as Ge,c as Re,d as S}from"./select-CQfvDDtS.js";import"./supabase-vendor-VSDMYZ1k.js";import"./index-DjQc2W_p.js";import"./index-CVwUD2ep.js";import"./index-aqCwQlp3.js";import"./index-BdQq_4o_.js";import"./index-BC78nHQ6.js";function _s(){var V,E,L,M,H,I,U,B,q,z,O,$,G,R,J,K,Z,Q;const v=we(),{isAdmin:f,loading:w}=be(),[P,le]=x.useState([]),[_e,me]=x.useState(!0),[F,he]=x.useState([]),[a,b]=x.useState(null),[ue,k]=x.useState(!1);x.useEffect(()=>{!w&&!f&&(h.error("Access denied. Admin only."),v("/catalog"))},[f,w,v]),x.useEffect(()=>{f&&(p(),A())},[f]);const p=async()=>{try{const{data:s,error:r}=await m.from("user_approval_status").select("*").eq("status","approved");if(r)throw r;const{data:o,error:W}=await m.from("user_roles").select("user_id").eq("role","admin");if(W)throw W;const ge=new Set((o==null?void 0:o.map(l=>l.user_id))||[]),fe=(s==null?void 0:s.filter(l=>!ge.has(l.user_id)))||[],{data:y,error:X}=await m.from("vendor_profiles").select("*");if(X)throw X;const{data:C,error:Y}=await m.from("products").select("user_id, deleted_at");if(Y)throw Y;const{data:N,error:ee}=await m.from("vendor_permissions").select("*");if(ee)throw ee;const ve=fe.map(l=>{const j=y==null?void 0:y.find(u=>u.user_id===l.user_id),se=(C==null?void 0:C.filter(u=>u.user_id===l.user_id))||[],n=N==null?void 0:N.find(u=>u.user_id===l.user_id);return{id:l.user_id,email:(j==null?void 0:j.email)||l.email||"N/A",business_name:j==null?void 0:j.business_name,is_enabled:l.is_enabled??!0,status:l.status,created_at:l.requested_at,product_count:se.filter(u=>!u.deleted_at).length,deleted_product_count:se.filter(u=>u.deleted_at).length,permissions:n?{can_view_catalog:n.can_view_catalog,can_add_products:n.can_add_products,can_import_data:n.can_import_data,can_share_catalog:n.can_share_catalog,can_manage_team:n.can_manage_team,can_view_interests:n.can_view_interests,can_delete_products:n.can_delete_products,can_edit_products:n.can_edit_products,can_edit_profile:n.can_edit_profile,can_add_vendor_details:n.can_add_vendor_details,can_view_custom_orders:n.can_view_custom_orders,can_manage_custom_orders:n.can_manage_custom_orders,can_view_share_links:n.can_view_share_links,can_manage_share_links:n.can_manage_share_links,can_view_sessions:n.can_view_sessions??!0,can_manage_sessions:n.can_manage_sessions??!0,max_active_sessions:n.max_active_sessions??3,subscription_plan:n.subscription_plan,max_products:n.max_products,max_share_links:n.max_share_links,max_team_members:n.max_team_members,max_product_images:n.max_product_images}:void 0}});le(ve)}catch(s){h.error("Failed to fetch vendors"),console.error(s)}finally{me(!1)}},A=async()=>{try{const{data:s,error:r}=await m.from("products").select("*").not("deleted_at","is",null).order("deleted_at",{ascending:!1});if(r)throw r;he(s||[])}catch(s){console.error("Failed to fetch deleted products:",s)}},xe=async(s,r)=>{try{const{error:o}=await m.from("user_approval_status").update({is_enabled:!r}).eq("user_id",s);if(o)throw o;h.success(`Vendor ${r?"disabled":"enabled"} successfully`),p()}catch(o){h.error("Failed to update vendor status"),console.error(o)}},pe=async s=>{if(b(s),!s.permissions)try{const{error:r}=await m.from("vendor_permissions").insert({user_id:s.id,can_view_catalog:!0,can_add_products:!0,can_import_data:!0,can_share_catalog:!0,can_manage_team:!1,can_view_interests:!0,can_delete_products:!0,can_edit_products:!0,can_edit_profile:!0,can_add_vendor_details:!0,can_view_custom_orders:!0,can_manage_custom_orders:!1,can_view_share_links:!0,can_manage_share_links:!0});if(r)throw r;await p()}catch(r){console.error("Failed to create default permissions:",r),h.error("Failed to initialize permissions");return}k(!0)},je=async s=>{try{const{error:r}=await m.rpc("hard_delete_products",{product_ids:s});if(r)throw r;h.success(`${s.length} product(s) permanently deleted`),A(),p()}catch(r){h.error("Failed to delete products permanently"),console.error(r)}},T=async(s,r)=>{try{const{error:o}=await m.from("vendor_permissions").update(r).eq("user_id",s);if(o)throw o;h.success("Permissions updated successfully"),p()}catch(o){h.error("Failed to update permissions"),console.error(o)}},c=(s,r)=>{a&&(b({...a,permissions:{...a.permissions,[s]:r}}),T(a.id,{[s]:r}))};return w||_e?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-pulse",children:"Loading vendor management..."})}):f?e.jsx(ke,{children:e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"border-b border-border bg-card/50 backdrop-blur-sm sticky top-0 z-10",children:e.jsx("div",{className:"container mx-auto px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Vendor Management"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage vendors and deleted products"})]}),e.jsxs(D,{variant:"outline",onClick:()=>v("/admin"),children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Back to Dashboard"]})]})})}),e.jsxs("main",{className:"container mx-auto px-6 py-8 space-y-8",children:[e.jsxs(ae,{children:[e.jsxs(re,{children:[e.jsx(ne,{children:"Vendors"}),e.jsx(ie,{children:"Manage vendor accounts and their status"})]}),e.jsx(te,{children:e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(g,{children:[e.jsx(_,{children:"Business Name"}),e.jsx(_,{children:"Email"}),e.jsx(_,{children:"Products"}),e.jsx(_,{children:"Deleted"}),e.jsx(_,{children:"Status"}),e.jsx(_,{children:"Enabled"}),e.jsx(_,{children:"Actions"})]})}),e.jsxs(oe,{children:[P.map(s=>e.jsxs(g,{children:[e.jsx(d,{className:"font-medium",children:s.business_name||"No business name"}),e.jsx(d,{children:s.email}),e.jsx(d,{children:s.product_count}),e.jsx(d,{children:s.deleted_product_count}),e.jsx(d,{children:e.jsx(ye,{variant:s.status==="approved"?"default":"secondary",children:s.status})}),e.jsx(d,{children:e.jsx(t,{checked:s.is_enabled,onCheckedChange:()=>xe(s.id,s.is_enabled)})}),e.jsx(d,{children:e.jsxs(D,{variant:"outline",size:"sm",onClick:()=>pe(s),children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Permissions"]})})]},s.id)),P.length===0&&e.jsx(g,{children:e.jsx(d,{colSpan:7,className:"text-center text-muted-foreground",children:"No vendors found"})})]})]})})]}),e.jsx(He,{open:ue,onOpenChange:k,children:e.jsxs(Ie,{className:"max-w-md max-h-[80vh] overflow-y-auto",children:[e.jsxs(Ue,{children:[e.jsx(Be,{children:"Vendor Permissions"}),e.jsxs(qe,{children:["Configure what ",(a==null?void 0:a.business_name)||(a==null?void 0:a.email)," can do"]})]}),a&&e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2 pb-4 border-b",children:[e.jsx(i,{htmlFor:"subscription_plan",children:"Subscription Plan"}),e.jsxs(Oe,{value:((V=a.permissions)==null?void 0:V.subscription_plan)||"starter",onValueChange:async s=>{try{const{error:r}=await m.from("vendor_permissions").update({subscription_plan:s}).eq("user_id",a.id);if(r)throw r;h.success(`Plan updated to ${s}. Permissions will refresh automatically.`),setTimeout(()=>{p(),k(!1)},1e3)}catch(r){h.error("Failed to update subscription plan"),console.error(r)}},children:[e.jsx($e,{children:e.jsx(Ge,{placeholder:"Select a plan"})}),e.jsxs(Re,{children:[e.jsx(S,{value:"starter",children:"Starter - 100 products, 1 share link, limited features"}),e.jsx(S,{value:"professional",children:"Professional - 1,000 products, 10 share links, all features"}),e.jsx(S,{value:"enterprise",children:"Enterprise - Unlimited everything"})]})]}),a.permissions&&e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1 mt-2",children:[e.jsxs("p",{children:["• Products: ",a.permissions.max_products===999999?"Unlimited":a.permissions.max_products]}),e.jsxs("p",{children:["• Share Links: ",a.permissions.max_share_links===999999?"Unlimited":a.permissions.max_share_links]}),e.jsxs("p",{children:["• Team Members: ",a.permissions.max_team_members===999999?"Unlimited":a.permissions.max_team_members]}),e.jsxs("p",{children:["• Product Images: ",a.permissions.max_product_images===999999?"Unlimited":a.permissions.max_product_images]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_view_catalog",children:"View Catalog"}),e.jsx(t,{id:"can_view_catalog",checked:((E=a.permissions)==null?void 0:E.can_view_catalog)??!0,onCheckedChange:s=>c("can_view_catalog",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_add_vendor_details",children:"Add Vendor Details"}),e.jsx(t,{id:"can_add_vendor_details",checked:((L=a.permissions)==null?void 0:L.can_add_vendor_details)??!0,onCheckedChange:s=>c("can_add_vendor_details",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_add_products",children:"Add Products"}),e.jsx(t,{id:"can_add_products",checked:((M=a.permissions)==null?void 0:M.can_add_products)??!0,onCheckedChange:s=>c("can_add_products",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_import_data",children:"Import Data"}),e.jsx(t,{id:"can_import_data",checked:((H=a.permissions)==null?void 0:H.can_import_data)??!0,onCheckedChange:s=>c("can_import_data",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_view_share_links",children:"View Share Links"}),e.jsx(t,{id:"can_view_share_links",checked:((I=a.permissions)==null?void 0:I.can_view_share_links)??!0,onCheckedChange:s=>c("can_view_share_links",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_manage_share_links",children:"Manage Share Links"}),e.jsx(t,{id:"can_manage_share_links",checked:((U=a.permissions)==null?void 0:U.can_manage_share_links)??!0,onCheckedChange:s=>c("can_manage_share_links",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_share_catalog",children:"Share Catalog"}),e.jsx(t,{id:"can_share_catalog",checked:((B=a.permissions)==null?void 0:B.can_share_catalog)??!0,onCheckedChange:s=>c("can_share_catalog",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_manage_team",children:"Manage Team"}),e.jsx(t,{id:"can_manage_team",checked:((q=a.permissions)==null?void 0:q.can_manage_team)??!1,onCheckedChange:s=>c("can_manage_team",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_view_interests",children:"View Interests"}),e.jsx(t,{id:"can_view_interests",checked:((z=a.permissions)==null?void 0:z.can_view_interests)??!0,onCheckedChange:s=>c("can_view_interests",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_view_custom_orders",children:"View Custom Orders"}),e.jsx(t,{id:"can_view_custom_orders",checked:((O=a.permissions)==null?void 0:O.can_view_custom_orders)??!0,onCheckedChange:s=>c("can_view_custom_orders",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_manage_custom_orders",children:"Manage Custom Orders"}),e.jsx(t,{id:"can_manage_custom_orders",checked:(($=a.permissions)==null?void 0:$.can_manage_custom_orders)??!1,onCheckedChange:s=>c("can_manage_custom_orders",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_delete_products",children:"Delete Products"}),e.jsx(t,{id:"can_delete_products",checked:((G=a.permissions)==null?void 0:G.can_delete_products)??!0,onCheckedChange:s=>c("can_delete_products",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_edit_products",children:"Edit Products"}),e.jsx(t,{id:"can_edit_products",checked:((R=a.permissions)==null?void 0:R.can_edit_products)??!0,onCheckedChange:s=>c("can_edit_products",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_edit_profile",children:"Edit Profile"}),e.jsx(t,{id:"can_edit_profile",checked:((J=a.permissions)==null?void 0:J.can_edit_profile)??!0,onCheckedChange:s=>c("can_edit_profile",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_view_sessions",children:"View Sessions"}),e.jsx(t,{id:"can_view_sessions",checked:((K=a.permissions)==null?void 0:K.can_view_sessions)??!0,onCheckedChange:s=>c("can_view_sessions",s)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(i,{htmlFor:"can_manage_sessions",children:"Manage Sessions"}),e.jsx(t,{id:"can_manage_sessions",checked:((Z=a.permissions)==null?void 0:Z.can_manage_sessions)??!0,onCheckedChange:s=>c("can_manage_sessions",s)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"max_active_sessions",children:"Max Active Sessions"}),e.jsx(ze,{id:"max_active_sessions",type:"number",min:"1",max:"10",value:((Q=a.permissions)==null?void 0:Q.max_active_sessions)??3,onChange:s=>{const r=parseInt(s.target.value)||3;r>=1&&r<=10&&(T(a.id,{max_active_sessions:r}),b({...a,permissions:{...a.permissions,max_active_sessions:r}}))},className:"w-full"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Number of devices that can be logged in simultaneously (1-10)"})]})]})]})}),e.jsxs(ae,{children:[e.jsxs(re,{children:[e.jsx(ne,{children:"Deleted Products"}),e.jsx(ie,{children:"Permanently delete products that were soft-deleted by vendors"})]}),e.jsx(te,{children:e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(g,{children:[e.jsx(_,{children:"Name"}),e.jsx(_,{children:"SKU"}),e.jsx(_,{children:"Category"}),e.jsx(_,{children:"Deleted At"}),e.jsx(_,{children:"Action"})]})}),e.jsxs(oe,{children:[F.map(s=>e.jsxs(g,{children:[e.jsx(d,{className:"font-medium",children:s.name}),e.jsx(d,{children:s.sku||"N/A"}),e.jsx(d,{children:s.category||"N/A"}),e.jsx(d,{children:new Date(s.deleted_at).toLocaleString()}),e.jsx(d,{children:e.jsxs(Se,{children:[e.jsx(Pe,{asChild:!0,children:e.jsxs(D,{variant:"destructive",size:"sm",children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Hard Delete"]})}),e.jsxs(Fe,{children:[e.jsxs(Ae,{children:[e.jsx(Te,{children:"Permanently Delete Product?"}),e.jsxs(Ve,{children:['This will permanently delete "',s.name,'". This action cannot be undone.']})]}),e.jsxs(Ee,{children:[e.jsx(Le,{children:"Cancel"}),e.jsx(Me,{onClick:()=>je([s.id]),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Permanently Delete"})]})]})]})})]},s.id)),F.length===0&&e.jsx(g,{children:e.jsx(d,{colSpan:5,className:"text-center text-muted-foreground",children:"No deleted products"})})]})]})})]})]})]})}):null}export{_s as default};
//# sourceMappingURL=VendorManagement-CGrUJuwB.js.map
