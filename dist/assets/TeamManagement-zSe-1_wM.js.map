{"version":3,"file":"TeamManagement-zSe-1_wM.js","sources":["../../src/pages/TeamManagement.tsx"],"sourcesContent":["import { useState, useEffect } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { supabase } from \"@/integrations/supabase/client\";\r\nimport { ApprovalGuard } from \"@/components/ApprovalGuard\";\r\nimport { useUserRole } from \"@/hooks/useUserRole\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { toast } from \"sonner\";\r\nimport { ArrowLeft, Trash2, UserPlus } from \"lucide-react\";\r\n\r\ninterface TeamMember {\r\n  id: string;\r\n  email: string;\r\n  role: string;\r\n  created_at: string;\r\n}\r\n\r\nexport default function TeamManagement() {\r\n  const navigate = useNavigate();\r\n  const { isAdmin, loading: roleLoading } = useUserRole();\r\n  const [teamMembers, setTeamMembers] = useState<TeamMember[]>([]);\r\n  const [newMemberEmail, setNewMemberEmail] = useState(\"\");\r\n  const [newMemberPassword, setNewMemberPassword] = useState(\"\");\r\n  const [isLoading, setIsLoading] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (!roleLoading && !isAdmin) {\r\n      toast.error(\"Access denied. Admin only.\");\r\n      navigate(\"/catalog\");\r\n    }\r\n  }, [isAdmin, roleLoading, navigate]);\r\n\r\n  useEffect(() => {\r\n    if (isAdmin) {\r\n      fetchTeamMembers();\r\n    }\r\n  }, [isAdmin]);\r\n\r\n  const fetchTeamMembers = async () => {\r\n    const { data, error } = await supabase\r\n      .from(\"user_roles\")\r\n      .select(`\r\n        id,\r\n        role,\r\n        created_at,\r\n        user_id\r\n      `)\r\n      .eq(\"role\", \"team_member\");\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to fetch team members\");\r\n      return;\r\n    }\r\n\r\n    // Fetch user emails from auth\r\n    const userIds = data.map(m => m.user_id);\r\n    const members: TeamMember[] = [];\r\n\r\n    for (const member of data) {\r\n      const { data: userData } = await supabase.auth.admin.getUserById(member.user_id);\r\n      if (userData.user) {\r\n        members.push({\r\n          id: member.id,\r\n          email: userData.user.email || \"Unknown\",\r\n          role: member.role,\r\n          created_at: member.created_at,\r\n        });\r\n      }\r\n    }\r\n\r\n    setTeamMembers(members);\r\n  };\r\n\r\n  const handleAddTeamMember = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      // Create new user\r\n      const { data: authData, error: authError } = await supabase.auth.signUp({\r\n        email: newMemberEmail,\r\n        password: newMemberPassword,\r\n        options: {\r\n          emailRedirectTo: `${window.location.origin}/catalog`,\r\n        },\r\n      });\r\n\r\n      if (authError) throw authError;\r\n\r\n      if (!authData.user) {\r\n        throw new Error(\"Failed to create user\");\r\n      }\r\n\r\n      // Assign team_member role\r\n      const { error: roleError } = await supabase\r\n        .from(\"user_roles\")\r\n        .insert({\r\n          user_id: authData.user.id,\r\n          role: \"team_member\",\r\n        });\r\n\r\n      if (roleError) throw roleError;\r\n\r\n      // Auto-approve admin-created accounts\r\n      const { error: approvalError } = await supabase\r\n        .from(\"user_approval_status\")\r\n        .update({\r\n          status: \"approved\",\r\n          reviewed_at: new Date().toISOString(),\r\n          reviewed_by: (await supabase.auth.getUser()).data.user?.id,\r\n        })\r\n        .eq(\"user_id\", authData.user.id);\r\n\r\n      if (approvalError) {\r\n        console.error(\"Error approving user:\", approvalError);\r\n      }\r\n\r\n      toast.success(\"Team member added and approved successfully\");\r\n      setNewMemberEmail(\"\");\r\n      setNewMemberPassword(\"\");\r\n      fetchTeamMembers();\r\n    } catch (error: any) {\r\n      toast.error(error.message || \"Failed to add team member\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleRemoveTeamMember = async (roleId: string) => {\r\n    const { error } = await supabase\r\n      .from(\"user_roles\")\r\n      .delete()\r\n      .eq(\"id\", roleId);\r\n\r\n    if (error) {\r\n      toast.error(\"Failed to remove team member\");\r\n      return;\r\n    }\r\n\r\n    toast.success(\"Team member removed successfully\");\r\n    fetchTeamMembers();\r\n  };\r\n\r\n  if (roleLoading) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center\">\r\n        <div className=\"animate-pulse\">Loading...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!isAdmin) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <ApprovalGuard>\r\n      <div className=\"min-h-screen bg-background p-6\">\r\n        <div className=\"max-w-6xl mx-auto space-y-6\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h1 className=\"text-3xl font-bold\">Team Management</h1>\r\n              <p className=\"text-muted-foreground mt-2\">Manage your team members and their access</p>\r\n            </div>\r\n            <Button variant=\"outline\" onClick={() => navigate(\"/catalog\")}>\r\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n              Back to Catalog\r\n            </Button>\r\n          </div>\r\n\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Add Team Member</CardTitle>\r\n              <CardDescription>\r\n                Create a new team member account. They will be able to view inventory and create share links.\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <form onSubmit={handleAddTeamMember} className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <Input\r\n                    type=\"email\"\r\n                    placeholder=\"Email\"\r\n                    value={newMemberEmail}\r\n                    onChange={(e) => setNewMemberEmail(e.target.value)}\r\n                    required\r\n                  />\r\n                  <Input\r\n                    type=\"password\"\r\n                    placeholder=\"Password\"\r\n                    value={newMemberPassword}\r\n                    onChange={(e) => setNewMemberPassword(e.target.value)}\r\n                    required\r\n                  />\r\n                </div>\r\n                <Button type=\"submit\" disabled={isLoading}>\r\n                  <UserPlus className=\"mr-2 h-4 w-4\" />\r\n                  {isLoading ? \"Adding...\" : \"Add Team Member\"}\r\n                </Button>\r\n              </form>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Team Members</CardTitle>\r\n              <CardDescription>\r\n                View and manage all team members\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead>Email</TableHead>\r\n                    <TableHead>Role</TableHead>\r\n                    <TableHead>Added</TableHead>\r\n                    <TableHead className=\"text-right\">Actions</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {teamMembers.length === 0 ? (\r\n                    <TableRow>\r\n                      <TableCell colSpan={4} className=\"text-center text-muted-foreground\">\r\n                        No team members yet\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ) : (\r\n                    teamMembers.map((member) => (\r\n                      <TableRow key={member.id}>\r\n                        <TableCell>{member.email}</TableCell>\r\n                        <TableCell>\r\n                          <Badge variant=\"secondary\">Team Member</Badge>\r\n                        </TableCell>\r\n                        <TableCell>\r\n                          {new Date(member.created_at).toLocaleDateString()}\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"sm\"\r\n                            onClick={() => handleRemoveTeamMember(member.id)}\r\n                          >\r\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\r\n                          </Button>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    ))\r\n                  )}\r\n                </TableBody>\r\n              </Table>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n    </ApprovalGuard>\r\n  );\r\n}\r\n"],"names":["TeamManagement","navigate","useNavigate","isAdmin","roleLoading","useUserRole","teamMembers","setTeamMembers","useState","newMemberEmail","setNewMemberEmail","newMemberPassword","setNewMemberPassword","isLoading","setIsLoading","useEffect","toast","fetchTeamMembers","data","error","supabase","m","members","member","userData","handleAddTeamMember","e","authData","authError","roleError","approvalError","_a","handleRemoveTeamMember","roleId","jsx","ApprovalGuard","jsxs","Button","ArrowLeft","Card","CardHeader","CardTitle","CardDescription","CardContent","Input","UserPlus","Table","TableHeader","TableRow","TableHead","TableBody","TableCell","Badge","Trash2"],"mappings":"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"}